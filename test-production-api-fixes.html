<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production API Fix Validation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 15px;
            display: inline-block;
        }
        .pending { background-color: #FFA726; }
        .success { background-color: #4CAF50; }
        .error { background-color: #F44336; }
        .test-button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .test-button:hover {
            background-color: #1976D2;
        }
        .results {
            margin-top: 15px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .production-url {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß Production API Fix Validation</h1>
        <p>Testing fixes for profile update & study creation issues</p>
    </div>

    <div class="production-url">
        <strong>Production URL:</strong> https://researchhub-saas.vercel.app
    </div>

    <div class="test-section">
        <h2>Issue #1: Profile Update 500 Error</h2>
        <div>
            <span class="status pending" id="profile-status"></span>
            <strong>Profile Update API Test</strong>
            <p>Testing user profile update endpoint that was returning 500 errors</p>
            <button class="test-button" onclick="testProfileUpdate()">Test Profile Update</button>
            <button class="test-button" onclick="testProfileUpdateProduction()">Test Production</button>
        </div>
        <div class="results" id="profile-results" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>Issue #2: Study Creation Failure</h2>
        <div>
            <span class="status pending" id="study-status"></span>
            <strong>Study Creation API Test</strong>
            <p>Testing study creation endpoint that was failing on production</p>
            <button class="test-button" onclick="testStudyCreation()">Test Study Creation</button>
            <button class="test-button" onclick="testStudyCreationProduction()">Test Production</button>
        </div>
        <div class="results" id="study-results" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>Issue #3: Google OAuth Error</h2>
        <div>
            <span class="status pending" id="oauth-status"></span>
            <strong>Google OAuth Configuration</strong>
            <p>Google OAuth provider needs to be enabled in Supabase dashboard</p>
            <button class="test-button" onclick="testOAuthConfig()">Check Configuration</button>
            <button class="test-button" onclick="showOAuthInstructions()">Show Fix Instructions</button>
        </div>
        <div class="results" id="oauth-results" style="display: none;"></div>
    </div>

    <script>
        function updateStatus(testId, status, message) {
            const statusElement = document.getElementById(testId + '-status');
            const resultsElement = document.getElementById(testId + '-results');
            
            statusElement.className = `status ${status}`;
            resultsElement.style.display = 'block';
            resultsElement.textContent = message;
        }

        async function testProfileUpdate() {
            updateStatus('profile', 'pending', 'Testing local profile update API...');
            
            try {
                // Test local API
                const response = await fetch('http://localhost:3003/api/user-profile-consolidated?action=update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer fallback-token-user-1-researcher'
                    },
                    body: JSON.stringify({
                        firstName: 'Updated',
                        lastName: 'Name'
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    updateStatus('profile', 'success', 
                        `‚úÖ Local Profile Update Fixed!\nStatus: ${response.status}\nResponse: ${JSON.stringify(result, null, 2)}`
                    );
                } else {
                    updateStatus('profile', 'error', 
                        `‚ùå Local test failed: ${response.status}\nError: ${JSON.stringify(result, null, 2)}`
                    );
                }
            } catch (error) {
                updateStatus('profile', 'error', `‚ùå Local test error: ${error.message}`);
            }
        }

        async function testProfileUpdateProduction() {
            updateStatus('profile', 'pending', 'Testing production profile update API...');
            
            try {
                // This would require actual auth token - just check if endpoint exists
                const response = await fetch('https://researchhub-saas.vercel.app/api/user-profile-consolidated?action=update', {
                    method: 'OPTIONS'
                });

                if (response.ok) {
                    updateStatus('profile', 'success', 
                        `‚úÖ Production Profile Update Endpoint Available!\nStatus: ${response.status}\nCORS Headers: ${response.headers.get('Access-Control-Allow-Methods')}`
                    );
                } else {
                    updateStatus('profile', 'error', 
                        `‚ùå Production endpoint issue: ${response.status}`
                    );
                }
            } catch (error) {
                updateStatus('profile', 'error', `‚ùå Production test error: ${error.message}`);
            }
        }

        async function testStudyCreation() {
            updateStatus('study', 'pending', 'Testing local study creation API...');
            
            try {
                const response = await fetch('http://localhost:3003/api/research-consolidated?action=create-study', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer fallback-token-user-1-researcher'
                    },
                    body: JSON.stringify({
                        title: 'Test Study',
                        description: 'API Fix Test Study',
                        type: 'usability'
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    updateStatus('study', 'success', 
                        `‚úÖ Local Study Creation Fixed!\nStatus: ${response.status}\nStudy ID: ${result.study?.id}\nResponse: ${JSON.stringify(result, null, 2)}`
                    );
                } else {
                    updateStatus('study', 'error', 
                        `‚ùå Local test failed: ${response.status}\nError: ${JSON.stringify(result, null, 2)}`
                    );
                }
            } catch (error) {
                updateStatus('study', 'error', `‚ùå Local test error: ${error.message}`);
            }
        }

        async function testStudyCreationProduction() {
            updateStatus('study', 'pending', 'Testing production study creation API...');
            
            try {
                // Test OPTIONS request to check if endpoint exists
                const response = await fetch('https://researchhub-saas.vercel.app/api/research-consolidated?action=create-study', {
                    method: 'OPTIONS'
                });

                if (response.ok) {
                    updateStatus('study', 'success', 
                        `‚úÖ Production Study Creation Endpoint Available!\nStatus: ${response.status}\nCORS Headers: ${response.headers.get('Access-Control-Allow-Methods')}`
                    );
                } else {
                    updateStatus('study', 'error', 
                        `‚ùå Production endpoint issue: ${response.status}`
                    );
                }
            } catch (error) {
                updateStatus('study', 'error', `‚ùå Production test error: ${error.message}`);
            }
        }

        function testOAuthConfig() {
            updateStatus('oauth', 'pending', 'Checking Google OAuth configuration...');
            
            // This is a configuration issue, not a code issue
            updateStatus('oauth', 'error', 
                `‚ùå Google OAuth Provider Not Enabled in Supabase\n\nThis requires manual configuration in Supabase dashboard:\n1. Go to Authentication > Settings > OAuth\n2. Enable Google provider\n3. Add Client ID and Secret from Google Console\n4. Configure redirect URLs\n\nThis is a configuration issue, not a code bug.`
            );
        }

        function showOAuthInstructions() {
            updateStatus('oauth', 'pending', 'Showing Google OAuth setup instructions...');
            
            updateStatus('oauth', 'success', 
                `üîß Google OAuth Setup Instructions:\n\n1. Go to Supabase Dashboard:\n   https://app.supabase.com/project/wxpwxzdgdvinlbtnbgdf\n\n2. Navigate to: Authentication > Settings > OAuth\n\n3. Enable Google provider:\n   - Toggle "Enable Google Provider"\n   - Add Google Client ID\n   - Add Google Client Secret\n\n4. Set up redirect URLs:\n   - Development: http://localhost:5175/auth/callback\n   - Production: https://researchhub-saas.vercel.app/auth/callback\n\n5. Configure in Google Console:\n   - Create OAuth 2.0 credentials\n   - Add authorized domains\n   - Set redirect URIs\n\nNote: This is a configuration task, not a code fix.`
            );
        }

        // Auto-run tests on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                testProfileUpdate();
                setTimeout(() => testStudyCreation(), 2000);
                setTimeout(() => testOAuthConfig(), 4000);
            }, 1000);
        });
    </script>
</body>
</html>
