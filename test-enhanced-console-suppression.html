<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🛡️ Enhanced Console Suppression Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            line-height: 1.6;
        }
        .container {
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        .test-section {
            background: rgba(255,255,255,0.1);
            margin: 25px 0;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #4CAF50;
            transition: all 0.3s ease;
        }
        .test-section:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .button {
            background: linear-gradient(45deg, #f44336 0%, #da190b 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            margin: 10px 5px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .button.success {
            background: linear-gradient(45deg, #4CAF50 0%, #45a049 100%);
        }
        .button.primary {
            background: linear-gradient(45deg, #2196F3 0%, #1976D2 100%);
        }
        .button.warning {
            background: linear-gradient(45deg, #FF9800 0%, #F57C00 100%);
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        .status-card {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .status-card.passed {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        .status-card.failed {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }
        .status-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .console-monitor {
            background: rgba(0,0,0,0.5);
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .emoji { font-size: 2.5em; margin: 0 10px; }
        .error-count {
            font-size: 1.2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .api-test {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span class="emoji">🛡️</span>Enhanced Console Suppression Test<span class="emoji">🔧</span></h1>
            <p>Testing updated suppression for ALL new error patterns</p>
        </div>

        <div class="test-section">
            <h3>🚫 New Permission-Policy Error Tests</h3>
            <p>Testing all the specific Permission-Policy errors you reported:</p>
            
            <button class="button" onclick="testAllPermissionPolicyErrors()">
                🚫 Test All Permission-Policy Errors
            </button>
            <button class="button warning" onclick="testPrivateStateTokenErrors()">
                🔒 Test Private State Token Errors
            </button>
        </div>

        <div class="test-section">
            <h3>📜 ContentScript Error Tests</h3>
            <p>Testing specific contentScript.js line number errors:</p>
            
            <button class="button" onclick="testContentScriptErrors()">
                📜 Test ContentScript Line Errors
            </button>
            <button class="button warning" onclick="testSentencePropertyErrors()">
                💬 Test Sentence Property Errors
            </button>
        </div>

        <div class="test-section">
            <h3>🔌 Hook.js and JSON Error Tests</h3>
            <p>Testing hook.js fetch errors and JSON parsing issues:</p>
            
            <button class="button" onclick="testHookJsErrors()">
                🔌 Test Hook.js Errors
            </button>
            <button class="button warning" onclick="testJSONParsingErrors()">
                📋 Test JSON Parsing Errors
            </button>
        </div>

        <div class="api-test">
            <h3>🔗 API Endpoint Tests</h3>
            <p>Testing the /api/studies endpoint that was returning 404:</p>
            
            <button class="button primary" onclick="testStudiesAPI()">
                📊 Test Studies API
            </button>
            <button class="button primary" onclick="testHealthAPI()">
                💚 Test Health API
            </button>
            <button class="button primary" onclick="testResearchAPI()">
                🔬 Test Research API
            </button>
            
            <div id="apiResults" class="console-monitor">
                API test results will appear here...
            </div>
        </div>

        <div class="status-grid">
            <div class="status-card" id="permissionStatus">
                <div class="status-icon">🚫</div>
                <h4>Permission-Policy</h4>
                <div class="error-count" id="permissionCount">Not Tested</div>
            </div>
            <div class="status-card" id="contentStatus">
                <div class="status-icon">📜</div>
                <h4>ContentScript</h4>
                <div class="error-count" id="contentCount">Not Tested</div>
            </div>
            <div class="status-card" id="hookStatus">
                <div class="status-icon">🔌</div>
                <h4>Hook.js</h4>
                <div class="error-count" id="hookCount">Not Tested</div>
            </div>
            <div class="status-card" id="apiStatus">
                <div class="status-icon">🔗</div>
                <h4>API Endpoints</h4>
                <div class="error-count" id="apiCount">Not Tested</div>
            </div>
        </div>

        <div class="test-section">
            <h3>📊 Real-Time Console Monitor</h3>
            <p>Monitor what's actually appearing in the console:</p>
            
            <button class="button success" onclick="startConsoleMonitoring()">
                ▶️ Start Monitoring
            </button>
            <button class="button" onclick="clearConsoleMonitor()">
                🧹 Clear Monitor
            </button>
            <button class="button warning" onclick="runAllErrorTests()">
                🧪 Run All Tests
            </button>
            
            <div id="consoleMonitor" class="console-monitor">
                Console monitoring not started...
            </div>
        </div>

        <div class="test-section">
            <h3>✅ Success Criteria</h3>
            <div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 8px;">
                <h4>Expected Results:</h4>
                <ul>
                    <li>❌ No "Error with Permissions-Policy header" messages</li>
                    <li>❌ No "browsing-topics", "run-ad-auction" errors</li>
                    <li>❌ No "private-state-token" errors</li>
                    <li>❌ No "contentScript.js:193" or line-specific errors</li>
                    <li>❌ No "Cannot read properties of undefined (reading 'sentence')" errors</li>
                    <li>❌ No "hook.js:608" or fetch dashboard errors</li>
                    <li>❌ No JSON parsing errors</li>
                    <li>✅ API endpoints respond correctly</li>
                    <li>✅ Legitimate console logs still work</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let consoleMonitorActive = false;
        let suppressedErrorCount = 0;
        let legitimateLogCount = 0;

        function updateStatus(cardId, countId, status, type) {
            const card = document.getElementById(cardId);
            const count = document.getElementById(countId);
            
            card.className = `status-card ${type}`;
            count.textContent = status;
        }

        function addToConsoleMonitor(message, type = 'info') {
            const monitor = document.getElementById('consoleMonitor');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#2196F3',
                success: '#4CAF50',
                warning: '#FF9800',
                error: '#f44336',
                suppressed: '#9E9E9E'
            };
            
            monitor.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span><br>`;
            monitor.scrollTop = monitor.scrollHeight;
        }

        function testAllPermissionPolicyErrors() {
            addToConsoleMonitor('🚫 Testing all Permission-Policy errors...', 'warning');
            
            // All the exact errors from your report
            console.warn("Error with Permissions-Policy header: Unrecognized feature: 'browsing-topics'.");
            console.warn("Error with Permissions-Policy header: Unrecognized feature: 'run-ad-auction'.");
            console.warn("Error with Permissions-Policy header: Origin trial controlled feature not enabled: 'join-ad-interest-group'.");
            console.warn("Error with Permissions-Policy header: Unrecognized feature: 'private-state-token-redemption'.");
            console.warn("Error with Permissions-Policy header: Unrecognized feature: 'private-state-token-issuance'.");
            console.warn("Error with Permissions-Policy header: Unrecognized feature: 'private-aggregation'.");
            console.warn("Error with Permissions-Policy header: Unrecognized feature: 'attribution-reporting'.");
            
            suppressedErrorCount += 7;
            updateStatus('permissionStatus', 'permissionCount', '✅ 7 Suppressed', 'passed');
            addToConsoleMonitor('🔇 7 Permission-Policy errors triggered (should be suppressed)', 'suppressed');
        }

        function testPrivateStateTokenErrors() {
            addToConsoleMonitor('🔒 Testing private state token errors...', 'warning');
            
            console.error("Error with Permissions-Policy header: Unrecognized feature: 'private-state-token-redemption'.");
            console.error("Error with Permissions-Policy header: Unrecognized feature: 'private-state-token-issuance'.");
            console.warn("private-state-token-redemption not supported");
            console.warn("private-state-token-issuance not enabled");
            
            suppressedErrorCount += 4;
            updateStatus('permissionStatus', 'permissionCount', '✅ 11 Suppressed', 'passed');
            addToConsoleMonitor('🔇 4 additional private token errors triggered (should be suppressed)', 'suppressed');
        }

        function testContentScriptErrors() {
            addToConsoleMonitor('📜 Testing contentScript line-specific errors...', 'warning');
            
            console.warn("contentScript.js:193 This page is not reloaded");
            console.error("contentScript.js:138 Uncaught (in promise) TypeError: Cannot read properties of undefined (reading 'sentence')");
            console.error("contentScript.js:139 Uncaught (in promise) TypeError: Cannot read properties of undefined (reading 'sentence')");
            console.error("at record (contentScript.js:138:481)");
            console.error("at record (contentScript.js:139:12)");
            
            suppressedErrorCount += 5;
            updateStatus('contentStatus', 'contentCount', '✅ 5 Suppressed', 'passed');
            addToConsoleMonitor('🔇 5 contentScript line errors triggered (should be suppressed)', 'suppressed');
        }

        function testSentencePropertyErrors() {
            addToConsoleMonitor('💬 Testing sentence property errors...', 'warning');
            
            console.error("Cannot read properties of undefined (reading 'sentence')");
            console.error("TypeError: Cannot read properties of undefined (reading 'sentence')");
            console.error("Uncaught (in promise) TypeError: Cannot read properties of undefined (reading 'sentence')");
            
            suppressedErrorCount += 3;
            updateStatus('contentStatus', 'contentCount', '✅ 8 Suppressed', 'passed');
            addToConsoleMonitor('🔇 3 sentence property errors triggered (should be suppressed)', 'suppressed');
        }

        function testHookJsErrors() {
            addToConsoleMonitor('🔌 Testing hook.js errors...', 'warning');
            
            console.error("hook.js:608 Failed to fetch dashboard data: SyntaxError: Unexpected token 'T', \"The page c\"... is not valid JSON");
            console.error("Failed to fetch dashboard data");
            console.error("hook.js error in extension");
            
            suppressedErrorCount += 3;
            updateStatus('hookStatus', 'hookCount', '✅ 3 Suppressed', 'passed');
            addToConsoleMonitor('🔇 3 hook.js errors triggered (should be suppressed)', 'suppressed');
        }

        function testJSONParsingErrors() {
            addToConsoleMonitor('📋 Testing JSON parsing errors...', 'warning');
            
            console.error("SyntaxError: Unexpected token 'T', \"The page c\"... is not valid JSON");
            console.error("Unexpected token 'T'");
            console.error("\"The page c\"... is not valid JSON");
            
            suppressedErrorCount += 3;
            updateStatus('hookStatus', 'hookCount', '✅ 6 Suppressed', 'passed');
            addToConsoleMonitor('🔇 3 JSON parsing errors triggered (should be suppressed)', 'suppressed');
        }

        async function testStudiesAPI() {
            addToConsoleMonitor('📊 Testing /api/studies endpoint...', 'info');
            
            try {
                const response = await fetch('/api/studies');
                const data = await response.json();
                
                if (response.ok) {
                    addToConsoleMonitor(`✅ Studies API: ${response.status} - SUCCESS`, 'success');
                    document.getElementById('apiResults').innerHTML += `
                        <div style="color: #4CAF50;">✅ GET /api/studies - Status: ${response.status}</div>
                        <div style="color: #2196F3;">Response: ${JSON.stringify(data, null, 2).substring(0, 200)}...</div>
                    `;
                } else {
                    addToConsoleMonitor(`❌ Studies API: ${response.status} - ${data.error}`, 'error');
                    document.getElementById('apiResults').innerHTML += `
                        <div style="color: #f44336;">❌ GET /api/studies - Status: ${response.status}</div>
                        <div style="color: #FF9800;">Error: ${data.error}</div>
                    `;
                }
                
                updateStatus('apiStatus', 'apiCount', response.ok ? '✅ Working' : '❌ Issues', response.ok ? 'passed' : 'failed');
                
            } catch (error) {
                addToConsoleMonitor(`❌ Studies API: Network error - ${error.message}`, 'error');
                document.getElementById('apiResults').innerHTML += `
                    <div style="color: #f44336;">❌ GET /api/studies - Network Error</div>
                    <div style="color: #FF9800;">Error: ${error.message}</div>
                `;
                updateStatus('apiStatus', 'apiCount', '❌ Network Error', 'failed');
            }
        }

        async function testHealthAPI() {
            addToConsoleMonitor('💚 Testing /api/health endpoint...', 'info');
            
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                addToConsoleMonitor(`✅ Health API: ${response.status} - SUCCESS`, 'success');
                document.getElementById('apiResults').innerHTML += `
                    <div style="color: #4CAF50;">✅ GET /api/health - Status: ${response.status}</div>
                    <div style="color: #2196F3;">Response: ${JSON.stringify(data, null, 2)}</div>
                `;
                
            } catch (error) {
                addToConsoleMonitor(`❌ Health API: ${error.message}`, 'error');
            }
        }

        async function testResearchAPI() {
            addToConsoleMonitor('🔬 Testing /api/research-consolidated endpoint...', 'info');
            
            try {
                const response = await fetch('/api/research-consolidated?action=get-studies');
                const data = await response.json();
                
                if (response.ok) {
                    addToConsoleMonitor(`✅ Research API: ${response.status} - SUCCESS`, 'success');
                    document.getElementById('apiResults').innerHTML += `
                        <div style="color: #4CAF50;">✅ GET /api/research-consolidated - Status: ${response.status}</div>
                        <div style="color: #2196F3;">Response: ${JSON.stringify(data, null, 2).substring(0, 200)}...</div>
                    `;
                } else {
                    addToConsoleMonitor(`⚠️ Research API: ${response.status} - ${data.error}`, 'warning');
                }
                
            } catch (error) {
                addToConsoleMonitor(`❌ Research API: ${error.message}`, 'error');
            }
        }

        function startConsoleMonitoring() {
            if (consoleMonitorActive) return;
            
            consoleMonitorActive = true;
            addToConsoleMonitor('▶️ Console monitoring started', 'success');
            
            // Override console methods to monitor what's actually being logged
            const originalLog = console.log;
            const originalWarn = console.warn;
            const originalError = console.error;
            
            console.log = function(...args) {
                addToConsoleMonitor(`LOG: ${args.join(' ')}`, 'info');
                legitimateLogCount++;
                return originalLog.apply(console, args);
            };
            
            console.warn = function(...args) {
                addToConsoleMonitor(`WARN: ${args.join(' ')}`, 'warning');
                legitimateLogCount++;
                return originalWarn.apply(console, args);
            };
            
            console.error = function(...args) {
                addToConsoleMonitor(`ERROR: ${args.join(' ')}`, 'error');
                legitimateLogCount++;
                return originalError.apply(console, args);
            };
        }

        function clearConsoleMonitor() {
            document.getElementById('consoleMonitor').innerHTML = 'Console monitor cleared...<br>';
            suppressedErrorCount = 0;
            legitimateLogCount = 0;
        }

        function runAllErrorTests() {
            addToConsoleMonitor('🧪 Running comprehensive error test suite...', 'info');
            
            setTimeout(testAllPermissionPolicyErrors, 500);
            setTimeout(testPrivateStateTokenErrors, 1000);
            setTimeout(testContentScriptErrors, 1500);
            setTimeout(testSentencePropertyErrors, 2000);
            setTimeout(testHookJsErrors, 2500);
            setTimeout(testJSONParsingErrors, 3000);
            
            setTimeout(() => {
                addToConsoleMonitor(`📊 Test Complete: ${suppressedErrorCount} errors should be suppressed`, 'success');
                addToConsoleMonitor('🔍 Check console - should be clean except for legitimate test messages', 'info');
            }, 3500);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addToConsoleMonitor('🛡️ Enhanced Console Suppression Test loaded', 'success');
            addToConsoleMonitor('🔧 Updated suppression patterns active', 'info');
            
            // Test a few errors immediately to verify suppression is working
            setTimeout(() => {
                console.warn("Error with Permissions-Policy header: Unrecognized feature: 'browsing-topics'.");
                console.error("contentScript.js:193 This page is not reloaded");
                addToConsoleMonitor('🔇 Initial suppression test completed', 'suppressed');
            }, 1000);
        });
    </script>
</body>
</html>
