<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Reset & Auth Testing - ResearchHub</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
        .test-accounts { background: #e8f5e8; border-color: #4caf50; }
        .critical-rules { background: #ffe8e8; border-color: #f44336; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.success { background: #28a745; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 200px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .endpoint-url { font-family: monospace; background: #f8f9fa; padding: 2px 4px; border-radius: 3px; color: #e83e8c; }
        .highlight { background: yellow; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê ResearchHub Password Reset & Auth Testing</h1>
        
        <div class="test-section critical-rules">
            <h2>üö® MANDATORY TESTING RULES</h2>
            <p><strong>‚ùå DO NOT CREATE NEW ACCOUNTS ‚ùå</strong></p>            <p><strong>‚úÖ USE ONLY THESE 3 ACCOUNTS:</strong></p>
            <ol>
                <li><span class="highlight">abwanwr77+participant@gmail.com</span> / Testtest123 (participant)</li>
                <li><span class="highlight">abwanwr77+Researcher@gmail.com</span> / Testtest123 (researcher)</li>
                <li><span class="highlight">abwanwr77+admin@gmail.com</span> / Testtest123 (admin)</li>
            </ol>
        </div>

        <!-- Test Account Quick Select -->
        <div class="test-section test-accounts">
            <h3>üìã Quick Test Account Select</h3>
            <button onclick="selectAccount('participant')" class="success">Use Participant Account</button>
            <button onclick="selectAccount('researcher')" class="success">Use Researcher Account</button>
            <button onclick="selectAccount('admin')" class="success">Use Admin Account</button>
        </div>

        <!-- Consolidated Auth Testing -->
        <div class="test-section">
            <h3>üîê Authentication Testing (Consolidated API)</h3>
            <p>Endpoint: <span class="endpoint-url">/api/auth?action=[login|register|logout|refresh|status]</span></p>
            
            <div>
                <input type="email" id="authEmail" placeholder="Email" value="">
                <input type="password" id="authPassword" placeholder="Password" value="">
                <select id="authAction">
                    <option value="login">Login</option>
                    <option value="register">Register</option>
                    <option value="logout">Logout</option>
                    <option value="refresh">Refresh Token</option>
                    <option value="status">Check Status</option>
                </select>
                <button onclick="testAuth()">Test Auth</button>
            </div>
            <div id="authResult" class="result"></div>
        </div>

        <!-- Password Reset Testing -->
        <div class="test-section">
            <h3>üîë Password Reset Testing (Consolidated API)</h3>
            <p>Endpoint: <span class="endpoint-url">/api/password?action=[forgot|reset|change]</span></p>
            
            <div>
                <h4>Step 1: Request Password Reset</h4>
                <input type="email" id="resetEmail" placeholder="Email for reset" value="">
                <button onclick="testForgotPassword()" class="danger">Request Password Reset</button>
                <div id="forgotResult" class="result"></div>
            </div>

            <div>
                <h4>Step 2: Reset Password (with tokens from email)</h4>
                <input type="text" id="accessToken" placeholder="Access Token from email" style="width: 300px;">
                <input type="text" id="refreshToken" placeholder="Refresh Token from email" style="width: 300px;">
                <input type="password" id="newPassword" placeholder="New Password" value="">
                <button onclick="testResetPassword()" class="danger">Reset Password</button>
                <div id="resetResult" class="result"></div>
            </div>

            <div>
                <h4>Step 3: Change Password (authenticated)</h4>
                <input type="password" id="currentPassword" placeholder="Current Password" value="">
                <input type="password" id="changeNewPassword" placeholder="New Password" value="">
                <button onclick="testChangePassword()" class="danger">Change Password</button>
                <div id="changeResult" class="result"></div>
            </div>
        </div>

        <!-- Admin Setup -->
        <div class="test-section">
            <h3>‚ö° Admin Setup</h3>
            <p>Endpoint: <span class="endpoint-url">/api/admin-setup</span></p>
            <button onclick="setupAdmin()">Setup Admin Account</button>
            <button onclick="getTestAccounts()">Get Test Accounts Info</button>
            <div id="adminResult" class="result"></div>
        </div>

        <!-- Health Checks -->
        <div class="test-section">
            <h3>üè• Health Checks</h3>
            <button onclick="checkHealth()">Check API Health</button>
            <button onclick="checkDatabase()">Check Database</button>
            <div id="healthResult" class="result"></div>
        </div>

        <!-- Results Display -->
        <div class="test-section">
            <h3>üìä Current Session Info</h3>
            <button onclick="getCurrentStatus()">Get Current User Status</button>
            <div id="sessionInfo" class="result"></div>
        </div>
    </div>

    <script>
        const BASE_URL = 'https://researchhub-saas.vercel.app/api';
        
        // Test accounts as per mandatory rules
        const TEST_ACCOUNTS = {
            participant: {
                email: 'abwanwr77+participant@gmail.com',
                password: 'Testtest123',
                role: 'participant'
            },
            researcher: {
                email: 'abwanwr77+Researcher@gmail.com',
                password: 'Testtest123',
                role: 'researcher'
            },            admin: {
                email: 'abwanwr77+admin@gmail.com',
                password: 'Testtest123',
                role: 'admin'
            }
        };

        let authToken = localStorage.getItem('authToken');
        let refreshTokenStored = localStorage.getItem('refreshToken');

        function selectAccount(type) {
            const account = TEST_ACCOUNTS[type];
            document.getElementById('authEmail').value = account.email;
            document.getElementById('resetEmail').value = account.email;
              if (account.password) {
                document.getElementById('authPassword').value = account.password;
                document.getElementById('currentPassword').value = account.password;
            }
            
            showResult('authResult', `Selected ${type} account: ${account.email}`, 'info');
        }

        async function testAuth() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const action = document.getElementById('authAction').value;

            if (!email) {
                showResult('authResult', 'Please select a test account first!', 'error');
                return;
            }

            const body = action === 'status' ? {} : 
                        action === 'refresh' ? { refreshToken: refreshTokenStored } :
                        action === 'logout' ? {} :
                        { email, password };

            try {
                const response = await fetch(`${BASE_URL}/auth?action=${action}`, {
                    method: action === 'status' ? 'GET' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken ? `Bearer ${authToken}` : ''
                    },
                    body: action === 'status' ? undefined : JSON.stringify(body)
                });

                const result = await response.json();
                
                if (result.success && result.session) {
                    authToken = result.session.accessToken;
                    refreshTokenStored = result.session.refreshToken;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('refreshToken', refreshTokenStored);
                }

                showResult('authResult', JSON.stringify(result, null, 2), result.success ? 'success' : 'error');
            } catch (error) {
                showResult('authResult', `Error: ${error.message}`, 'error');
            }
        }

        async function testForgotPassword() {
            const email = document.getElementById('resetEmail').value;
            
            if (!email || (!email.includes('participant') && !email.includes('Researcher'))) {
                showResult('forgotResult', 'Error: Use ONLY participant or researcher accounts for password reset!', 'error');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/password?action=forgot`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const result = await response.json();
                showResult('forgotResult', JSON.stringify(result, null, 2), result.success ? 'success' : 'error');
            } catch (error) {
                showResult('forgotResult', `Error: ${error.message}`, 'error');
            }
        }

        async function testResetPassword() {
            const accessToken = document.getElementById('accessToken').value;
            const refreshToken = document.getElementById('refreshToken').value;
            const newPassword = document.getElementById('newPassword').value;

            if (!accessToken || !refreshToken || !newPassword) {
                showResult('resetResult', 'All fields required for password reset', 'error');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/password?action=reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accessToken, refreshToken, newPassword })
                });

                const result = await response.json();
                showResult('resetResult', JSON.stringify(result, null, 2), result.success ? 'success' : 'error');
            } catch (error) {
                showResult('resetResult', `Error: ${error.message}`, 'error');
            }
        }

        async function testChangePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('changeNewPassword').value;

            if (!currentPassword || !newPassword || !authToken) {
                showResult('changeResult', 'Current password, new password, and authentication required', 'error');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/password?action=change`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                const result = await response.json();
                showResult('changeResult', JSON.stringify(result, null, 2), result.success ? 'success' : 'error');
            } catch (error) {
                showResult('changeResult', `Error: ${error.message}`, 'error');
            }
        }

        async function setupAdmin() {
            try {                const response = await fetch(`${BASE_URL}/admin-setup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'create_admin_account'
                    })
                });

                const result = await response.json();
                showResult('adminResult', JSON.stringify(result, null, 2), result.success ? 'success' : 'error');
            } catch (error) {
                showResult('adminResult', `Error: ${error.message}`, 'error');
            }
        }

        async function getTestAccounts() {
            try {
                const response = await fetch(`${BASE_URL}/admin-setup`, {
                    method: 'GET'
                });

                const result = await response.json();
                showResult('adminResult', JSON.stringify(result, null, 2), result.success ? 'success' : 'error');
            } catch (error) {
                showResult('adminResult', `Error: ${error.message}`, 'error');
            }
        }

        async function checkHealth() {
            try {
                const response = await fetch(`${BASE_URL}/health`);
                const result = await response.json();
                showResult('healthResult', JSON.stringify(result, null, 2), result.success ? 'success' : 'error');
            } catch (error) {
                showResult('healthResult', `Error: ${error.message}`, 'error');
            }
        }

        async function checkDatabase() {
            try {
                const response = await fetch(`${BASE_URL}/db-check`);
                const result = await response.json();
                showResult('healthResult', JSON.stringify(result, null, 2), result.success ? 'success' : 'error');
            } catch (error) {
                showResult('healthResult', `Error: ${error.message}`, 'error');
            }
        }

        async function getCurrentStatus() {
            try {
                const response = await fetch(`${BASE_URL}/auth?action=status`, {
                    headers: {
                        'Authorization': authToken ? `Bearer ${authToken}` : ''
                    }
                });

                const result = await response.json();
                showResult('sessionInfo', JSON.stringify(result, null, 2), result.success ? 'success' : 'error');
            } catch (error) {
                showResult('sessionInfo', `Error: ${error.message}`, 'error');
            }
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            if (authToken) {
                showResult('sessionInfo', 'Auth token found in storage', 'info');
            }
        });
    </script>
</body>
</html>
