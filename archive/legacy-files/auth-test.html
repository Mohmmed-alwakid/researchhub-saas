<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResearchHub Auth Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .success { border-color: #4CAF50; background-color: #f8fff8; }
        .error { border-color: #f44336; background-color: #fff8f8; }
        .pending { border-color: #ff9800; background-color: #fff8f0; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-success { background-color: #4CAF50; }
        .status-error { background-color: #f44336; }
        .status-pending { background-color: #ff9800; }
    </style>
</head>
<body>
    <h1>üîê ResearchHub Authentication Test Suite</h1>
    <p><strong>Supabase Migration Test</strong> - June 18, 2025</p>

    <!-- Registration Test -->
    <div class="test-section pending" id="registerSection">
        <h2><span class="status-indicator status-pending"></span>Registration Test</h2>
        <p>Test user registration with Supabase backend</p>
        
        <input type="email" id="regEmail" placeholder="Email (e.g., test@gmail.com)" value="test456@gmail.com">
        <input type="password" id="regPassword" placeholder="Password" value="TestPassword123!">
        <input type="text" id="regFirstName" placeholder="First Name" value="Test">
        <input type="text" id="regLastName" placeholder="Last Name" value="User">
        <select id="regRole">
            <option value="researcher">Researcher</option>
            <option value="participant">Participant</option>
            <option value="admin">Admin</option>
        </select>
        
        <button onclick="testRegistration()">Test Registration</button>
        <div class="result" id="registerResult">Click "Test Registration" to begin...</div>
    </div>

    <!-- Login Test -->
    <div class="test-section pending" id="loginSection">
        <h2><span class="status-indicator status-pending"></span>Login Test</h2>
        <p>Test user login with confirmed email</p>
        
        <input type="email" id="loginEmail" placeholder="Email" value="test123@gmail.com">
        <input type="password" id="loginPassword" placeholder="Password" value="TestPassword123!">
        
        <button onclick="testLogin()">Test Login</button>
        <div class="result" id="loginResult">Register first, then confirm email, then test login...</div>
    </div>

    <!-- Token Status Test -->
    <div class="test-section pending" id="statusSection">
        <h2><span class="status-indicator status-pending"></span>Token Status Test</h2>
        <p>Test authentication status with token</p>
        
        <textarea id="testToken" placeholder="Paste JWT token here..." rows="3"></textarea>
        
        <button onclick="testStatus()">Test Status</button>
        <div class="result" id="statusResult">Login first to get a token...</div>
    </div>

    <!-- Token Refresh Test -->
    <div class="test-section pending" id="refreshSection">
        <h2><span class="status-indicator status-pending"></span>Token Refresh Test</h2>
        <p>Test token refresh functionality</p>
        
        <textarea id="refreshToken" placeholder="Paste refresh token here..." rows="3"></textarea>
        
        <button onclick="testRefresh()">Test Refresh</button>
        <div class="result" id="refreshResult">Login first to get a refresh token...</div>
    </div>

    <!-- Logout Test -->
    <div class="test-section pending" id="logoutSection">
        <h2><span class="status-indicator status-pending"></span>Logout Test</h2>
        <p>Test session cleanup</p>
        
        <button onclick="testLogout()">Test Logout</button>
        <div class="result" id="logoutResult">Click "Test Logout" to test session cleanup...</div>
    </div>

    <!-- System Status -->
    <div class="test-section success" id="systemSection">
        <h2><span class="status-indicator status-success"></span>System Status</h2>
        <p>Check overall system health</p>
        
        <button onclick="testHealth()">Check Health</button>
        <button onclick="testDbConnection()">Check Database</button>
        <div class="result" id="systemResult">System endpoints ready to test...</div>
    </div>

    <!-- Email Confirmation Test -->
    <div class="test-section pending" id="confirmSection">
        <h2><span class="status-indicator status-pending"></span>Email Confirmation Test</h2>
        <p>Manual email confirmation for testing</p>
        
        <input type="email" id="confirmEmail" placeholder="Email to confirm" value="test123@gmail.com">
        
        <button onclick="testEmailConfirmation()">Get Confirmation Instructions</button>
        <div class="result" id="confirmResult">Instructions for manual email confirmation...</div>
    </div>

    <!-- Full Authentication Flow Test -->
    <div class="test-section pending" id="fullFlowSection">
        <h2><span class="status-indicator status-pending"></span>Complete Auth Flow Test</h2>
        <p>End-to-end authentication workflow</p>
        
        <div style="margin: 10px 0;">
            <strong>Test Sequence:</strong>
            <ol>
                <li>Register new user</li>
                <li>Confirm email (manual)</li>
                <li>Login with credentials</li>
                <li>Check auth status</li>
                <li>Refresh token</li>
                <li>Logout</li>
            </ol>
        </div>
        
        <button onclick="runFullAuthFlow()">Run Complete Flow</button>
        <div class="result" id="fullFlowResult">Click to run complete authentication flow...</div>
    </div>

    <!-- Performance Test -->
    <div class="test-section pending" id="performanceSection">
        <h2><span class="status-indicator status-pending"></span>Performance Test</h2>
        <p>API response time and reliability testing</p>
        
        <button onclick="testPerformance()">Run Performance Tests</button>
        <div class="result" id="performanceResult">Performance metrics will be shown here...</div>
    </div>

    <script>
        const API_BASE = 'https://researchhub-saas.vercel.app/api';

        function updateSectionStatus(sectionId, status) {
            const section = document.getElementById(sectionId);
            const indicator = section.querySelector('.status-indicator');
            
            section.className = `test-section ${status}`;
            indicator.className = `status-indicator status-${status}`;
        }

        function displayResult(elementId, result, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(result, null, 2);
            
            const section = element.closest('.test-section');
            updateSectionStatus(section.id, isError ? 'error' : 'success');
        }

        async function makeRequest(endpoint, method = 'GET', body = null, token = null) {
            try {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch(`${API_BASE}/${endpoint}`, {
                    method,
                    headers,
                    body: body ? JSON.stringify(body) : null
                });

                const data = await response.json();
                return { status: response.status, data };
            } catch (error) {
                return { status: 0, data: { error: error.message } };
            }
        }

        async function testRegistration() {
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const firstName = document.getElementById('regFirstName').value;
            const lastName = document.getElementById('regLastName').value;
            const role = document.getElementById('regRole').value;

            const result = await makeRequest('register', 'POST', {
                email, password, firstName, lastName, role
            });

            displayResult('registerResult', result, result.status !== 201);

            // If successful, auto-fill login form
            if (result.status === 201) {
                document.getElementById('loginEmail').value = email;
                document.getElementById('loginPassword').value = password;
            }
        }

        async function testLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const result = await makeRequest('login', 'POST', { email, password });

            displayResult('loginResult', result, result.status !== 200);

            // If successful, auto-fill token fields
            if (result.status === 200 && result.data.session) {
                document.getElementById('testToken').value = result.data.session.access_token;
                document.getElementById('refreshToken').value = result.data.session.refresh_token;
            }
        }

        async function testStatus() {
            const token = document.getElementById('testToken').value;

            if (!token) {
                displayResult('statusResult', { error: 'Please provide a token' }, true);
                return;
            }

            const result = await makeRequest('status', 'GET', null, token);
            displayResult('statusResult', result, result.status !== 200);
        }

        async function testRefresh() {
            const refreshToken = document.getElementById('refreshToken').value;

            if (!refreshToken) {
                displayResult('refreshResult', { error: 'Please provide a refresh token' }, true);
                return;
            }

            const result = await makeRequest('refresh', 'POST', { refreshToken });
            displayResult('refreshResult', result, result.status !== 200);

            // If successful, update access token
            if (result.status === 200 && result.data.session) {
                document.getElementById('testToken').value = result.data.session.access_token;
            }
        }

        async function testLogout() {
            const token = document.getElementById('testToken').value;

            const result = await makeRequest('logout', 'POST', null, token);
            displayResult('logoutResult', result, result.status !== 200);
        }

        async function testHealth() {
            const result = await makeRequest('health');
            displayResult('systemResult', result, result.status !== 200);
        }

        async function testDbConnection() {
            const result = await makeRequest('db-check');
            const currentResult = document.getElementById('systemResult').textContent;
            displayResult('systemResult', { 
                health: JSON.parse(currentResult), 
                database: result 
            }, result.status !== 200);
        }

        async function testEmailConfirmation() {
            const email = document.getElementById('confirmEmail').value;

            if (!email) {
                displayResult('confirmResult', { error: 'Please provide an email' }, true);
                return;
            }

            const result = await makeRequest('confirm-email', 'POST', { email });
            displayResult('confirmResult', result, result.status !== 200);
        }

        async function runFullAuthFlow() {
            const results = {
                flow: 'Complete Authentication Flow Test',
                timestamp: new Date().toISOString(),
                steps: []
            };

            try {
                // Step 1: Register
                const regResult = await makeRequest('register', 'POST', {
                    email: 'fullflow@gmail.com',
                    password: 'TestFlow123!',
                    firstName: 'Full',
                    lastName: 'Flow',
                    role: 'researcher'
                });
                
                results.steps.push({
                    step: 1,
                    action: 'Registration',
                    status: regResult.status,
                    success: regResult.status === 201 || regResult.status === 400, // 400 for already exists
                    data: regResult.data
                });

                // Step 2: Try login (will fail due to unconfirmed email)
                const loginResult = await makeRequest('login', 'POST', {
                    email: 'fullflow@gmail.com',
                    password: 'TestFlow123!'
                });
                
                results.steps.push({
                    step: 2,
                    action: 'Login (unconfirmed)',
                    status: loginResult.status,
                    success: loginResult.status === 400, // Expected to fail
                    data: loginResult.data
                });

                // Step 3: Get confirmation instructions
                const confirmResult = await makeRequest('confirm-email', 'POST', {
                    email: 'fullflow@gmail.com'
                });
                
                results.steps.push({
                    step: 3,
                    action: 'Email confirmation instructions',
                    status: confirmResult.status,
                    success: confirmResult.status === 200,
                    data: confirmResult.data
                });

                // Step 4: Test other endpoints with invalid token
                const statusResult = await makeRequest('status', 'GET', null, 'invalid-token');
                
                results.steps.push({
                    step: 4,
                    action: 'Status check (invalid token)',
                    status: statusResult.status,
                    success: statusResult.status === 401, // Expected to fail
                    data: statusResult.data
                });

                // Step 5: Test logout
                const logoutResult = await makeRequest('logout', 'POST');
                
                results.steps.push({
                    step: 5,
                    action: 'Logout',
                    status: logoutResult.status,
                    success: logoutResult.status === 200,
                    data: logoutResult.data
                });

                results.summary = {
                    totalSteps: results.steps.length,
                    successfulSteps: results.steps.filter(s => s.success).length,
                    completionRate: (results.steps.filter(s => s.success).length / results.steps.length * 100).toFixed(1) + '%'
                };

                displayResult('fullFlowResult', results, false);

            } catch (error) {
                results.error = error.message;
                displayResult('fullFlowResult', results, true);
            }
        }

        async function testPerformance() {
            const results = {
                test: 'API Performance Analysis',
                timestamp: new Date().toISOString(),
                endpoints: []
            };

            const endpoints = [
                { name: 'Health Check', endpoint: 'health', method: 'GET' },
                { name: 'Database Check', endpoint: 'db-check', method: 'GET' },
                { name: 'Registration', endpoint: 'register', method: 'POST', body: {
                    email: 'perf@gmail.com',
                    password: 'PerfTest123!',
                    firstName: 'Perf',
                    lastName: 'Test',
                    role: 'researcher'
                }},
                { name: 'Login', endpoint: 'login', method: 'POST', body: {
                    email: 'perf@gmail.com',
                    password: 'PerfTest123!'
                }},
                { name: 'Logout', endpoint: 'logout', method: 'POST' }
            ];

            for (const endpoint of endpoints) {
                const times = [];
                
                // Run each endpoint 3 times to get average
                for (let i = 0; i < 3; i++) {
                    const startTime = performance.now();
                    const result = await makeRequest(endpoint.endpoint, endpoint.method, endpoint.body);
                    const endTime = performance.now();
                    
                    times.push({
                        attempt: i + 1,
                        responseTime: Math.round(endTime - startTime),
                        status: result.status,
                        success: result.status < 400 || result.status === 400 // 400 might be expected for duplicate registration
                    });
                    
                    // Small delay between requests
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                const avgTime = Math.round(times.reduce((sum, t) => sum + t.responseTime, 0) / times.length);
                const successRate = (times.filter(t => t.success).length / times.length * 100);

                results.endpoints.push({
                    name: endpoint.name,
                    averageResponseTime: avgTime + 'ms',
                    successRate: successRate + '%',
                    attempts: times
                });
            }

            results.summary = {
                totalEndpoints: results.endpoints.length,
                averageResponseTime: Math.round(
                    results.endpoints.reduce((sum, e) => sum + parseInt(e.averageResponseTime), 0) / results.endpoints.length
                ) + 'ms',
                overallSuccessRate: (
                    results.endpoints.reduce((sum, e) => sum + parseFloat(e.successRate), 0) / results.endpoints.length
                ).toFixed(1) + '%'
            };

            displayResult('performanceResult', results, false);
        }

        // Auto-test system status on page load
        window.onload = () => {
            testHealth();
        };
    </script>
</body>
</html>
