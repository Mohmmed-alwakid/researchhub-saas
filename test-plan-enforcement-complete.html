<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Enforcement Testing - ResearchHub</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        .test-section {
            padding: 30px;
            border-bottom: 1px solid #eee;
        }
        .test-section:last-child {
            border-bottom: none;
        }
        .test-section h2 {
            color: #333;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .test-group {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .test-description {
            flex: 1;
        }
        .test-description h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .test-description p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        .test-button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
        }
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-pending { background: #ffc107; }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .plan-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
        }
        .plan-free { background: #e9ecef; color: #495057; }
        .plan-basic { background: #cce5ff; color: #0066cc; }
        .plan-pro { background: #e6ccff; color: #6600cc; }
        .plan-enterprise { background: #ffe6cc; color: #cc6600; }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
            margin: 5px 0;
        }
        .metric-label {
            color: #666;
            font-size: 0.9em;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        .progress-success { background: #28a745; }
        .progress-warning { background: #ffc107; }
        .progress-danger { background: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Plan Enforcement Testing</h1>
            <p>Testing subscription limits, usage tracking, and upgrade flows</p>
            <div style="margin-top: 20px;">
                <span id="serverStatus" class="status-indicator status-pending"></span>
                <span>API Server Status: <span id="serverStatusText">Checking...</span></span>
            </div>
        </div>

        <!-- Test Scenarios Section -->
        <div class="test-section">
            <h2>üß™ Test Scenarios</h2>
            
            <!-- Free Plan Tests -->
            <div class="test-group">
                <h3>Free Plan User Tests <span class="plan-badge plan-free">Free</span></h3>
                
                <div class="test-item">
                    <div class="test-description">
                        <h4>Create Study #1 (Should Succeed)</h4>
                        <p>Free users can create up to 3 studies</p>
                    </div>
                    <button class="test-button" onclick="testCreateStudy('free', 1)">Test</button>
                </div>
                
                <div class="test-item">
                    <div class="test-description">
                        <h4>Create Study #4 (Should Fail)</h4>
                        <p>Should show plan limit error and upgrade prompt</p>
                    </div>
                    <button class="test-button" onclick="testCreateStudyLimit('free')">Test</button>
                </div>
                
                <div class="test-item">
                    <div class="test-description">
                        <h4>Export Data (Should Fail)</h4>
                        <p>Free plan doesn't include data export</p>
                    </div>
                    <button class="test-button" onclick="testFeatureLimit('free', 'export-data')">Test</button>
                </div>
            </div>

            <!-- Basic Plan Tests -->
            <div class="test-group">
                <h3>Basic Plan User Tests <span class="plan-badge plan-basic">Basic</span></h3>
                
                <div class="test-item">
                    <div class="test-description">
                        <h4>Create Study (Should Succeed)</h4>
                        <p>Basic users can create up to 15 studies</p>
                    </div>
                    <button class="test-button" onclick="testCreateStudy('basic', 1)">Test</button>
                </div>
                
                <div class="test-item">
                    <div class="test-description">
                        <h4>Export Data (Should Succeed)</h4>
                        <p>Basic plan includes data export feature</p>
                    </div>
                    <button class="test-button" onclick="testFeatureLimit('basic', 'export-data')">Test</button>
                </div>
                
                <div class="test-item">
                    <div class="test-description">
                        <h4>Team Collaboration (Should Fail)</h4>
                        <p>Team features require Pro plan</p>
                    </div>
                    <button class="test-button" onclick="testFeatureLimit('basic', 'team-collaboration')">Test</button>
                </div>
            </div>

            <!-- Pro Plan Tests -->
            <div class="test-group">
                <h3>Pro Plan User Tests <span class="plan-badge plan-pro">Pro</span></h3>
                
                <div class="test-item">
                    <div class="test-description">
                        <h4>Create Multiple Studies (Should Succeed)</h4>
                        <p>Pro users have unlimited studies</p>
                    </div>
                    <button class="test-button" onclick="testCreateStudy('pro', 5)">Test 5 Studies</button>
                </div>
                
                <div class="test-item">
                    <div class="test-description">
                        <h4>All Features Available</h4>
                        <p>Test all features are accessible</p>
                    </div>
                    <button class="test-button" onclick="testAllFeatures('pro')">Test All</button>
                </div>
            </div>
        </div>

        <!-- Usage Statistics Section -->
        <div class="test-section">
            <h2>üìä Usage Statistics</h2>
            
            <div class="test-item">
                <div class="test-description">
                    <h4>Get Current Usage Stats</h4>
                    <p>Fetch real-time usage data for authenticated user</p>
                </div>
                <button class="test-button" onclick="testUsageStats()">Get Stats</button>
            </div>

            <div id="usageMetrics" class="metrics-grid" style="display: none;">
                <!-- Usage metrics will be populated here -->
            </div>
        </div>

        <!-- Plan Comparison Section -->
        <div class="test-section">
            <h2>üí≥ Plan Comparison</h2>
            
            <div class="test-item">
                <div class="test-description">
                    <h4>Get Plan Comparison Data</h4>
                    <p>Fetch available plans and features for upgrade prompts</p>
                </div>
                <button class="test-button" onclick="testPlanComparison()">Get Plans</button>
            </div>
        </div>

        <!-- Results Section -->
        <div class="test-section">
            <h2>üìã Test Results</h2>
            <div id="testResults">
                <p style="color: #666; text-align: center; padding: 40px;">
                    Run tests above to see results here
                </p>
            </div>
        </div>
    </div>

    <script>
        // API Base URL
        const API_BASE = 'http://localhost:3003';
        
        // Test tokens for different user types
        const TEST_TOKENS = {
            free: 'fallback-token-free-user',
            basic: 'fallback-token-basic-user',
            pro: 'fallback-token-researcher-abwanwr77+Researcher',
            enterprise: 'fallback-token-admin-abwanwr77+admin'
        };

        let testCounter = 0;

        // Check server status on page load
        window.addEventListener('load', checkServerStatus);

        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('serverStatus').className = 'status-indicator status-success';
                    document.getElementById('serverStatusText').textContent = 'Online';
                } else {
                    throw new Error('Server health check failed');
                }
            } catch (error) {
                document.getElementById('serverStatus').className = 'status-indicator status-error';
                document.getElementById('serverStatusText').textContent = 'Offline';
                addResult('error', 'Server Status', `Failed to connect to API server: ${error.message}`);
            }
        }

        async function makeAPICall(endpoint, method = 'GET', data = null, token = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };

            if (token) {
                options.headers['Authorization'] = `Bearer ${token}`;
            }

            if (data) {
                options.body = JSON.stringify(data);
            }

            const response = await fetch(`${API_BASE}${endpoint}`, options);
            return await response.json();
        }

        async function testCreateStudy(planType, count = 1) {
            const token = TEST_TOKENS[planType];
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Testing...';

            try {
                const results = [];
                
                for (let i = 1; i <= count; i++) {
                    const studyData = {
                        action: 'create-study',
                        title: `${planType.charAt(0).toUpperCase() + planType.slice(1)} Plan Test Study ${i}`,
                        description: `Testing study creation for ${planType} plan user`,
                        type: 'usability'
                    };

                    const result = await makeAPICall('/api/research-consolidated', 'POST', studyData, token);
                    results.push({ attempt: i, result });
                }

                const successCount = results.filter(r => r.result.success).length;
                const errorResults = results.filter(r => !r.result.success);

                if (successCount === count) {
                    addResult('success', `Create ${count} Studies (${planType})`, 
                        `‚úÖ Successfully created ${successCount}/${count} studies\n\n` + 
                        results.map(r => `Study ${r.attempt}: ${r.result.study?.title || 'Created'}`).join('\n'));
                } else {
                    const summary = `‚ö†Ô∏è Created ${successCount}/${count} studies\n\n` +
                        `Successful: ${successCount}\n` +
                        `Failed: ${count - successCount}\n\n` +
                        `Errors:\n${errorResults.map(r => `Study ${r.attempt}: ${r.result.error}`).join('\n')}`;
                    
                    addResult(errorResults.some(r => r.result.planLimitExceeded) ? 'info' : 'error', 
                        `Create ${count} Studies (${planType})`, summary);
                }

            } catch (error) {
                addResult('error', `Create Studies (${planType})`, `‚ùå Test failed: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = count === 1 ? 'Test' : `Test ${count} Studies`;
            }
        }

        async function testCreateStudyLimit(planType) {
            const token = TEST_TOKENS[planType];
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Testing...';

            try {
                // First, create studies up to the limit
                const planLimits = { free: 3, basic: 15 };
                const limit = planLimits[planType];
                
                if (!limit) {
                    addResult('error', `Study Limit Test (${planType})`, 'Plan limit not defined for this plan type');
                    return;
                }

                // Try to create one study beyond the limit
                const studyData = {
                    action: 'create-study',
                    title: `${planType} Plan Limit Test - Should Fail`,
                    description: 'This study creation should trigger plan limit error',
                    type: 'usability'
                };

                const result = await makeAPICall('/api/research-consolidated', 'POST', studyData, token);

                if (result.planLimitExceeded) {
                    addResult('success', `Study Limit Test (${planType})`, 
                        `‚úÖ Plan enforcement working correctly!\n\n` +
                        `Error: ${result.error}\n` +
                        `Reason: ${result.details.reason}\n` +
                        `Current Plan: ${result.details.currentPlan}\n` +
                        `Required Plan: ${result.details.requiredPlan}\n` +
                        `Usage: ${result.details.currentUsage}/${result.details.planLimit}\n` +
                        `Upgrade Message: ${result.details.upgradeMessage}`);
                } else if (result.success) {
                    addResult('error', `Study Limit Test (${planType})`, 
                        `‚ùå Plan enforcement failed - study was created when it should have been blocked\n\n` +
                        `Created study: ${result.study?.title}`);
                } else {
                    addResult('error', `Study Limit Test (${planType})`, 
                        `‚ùå Unexpected error: ${result.error}`);
                }

            } catch (error) {
                addResult('error', `Study Limit Test (${planType})`, `‚ùå Test failed: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'Test';
            }
        }

        async function testFeatureLimit(planType, feature) {
            const token = TEST_TOKENS[planType];
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Testing...';

            try {
                const featureData = {
                    action: feature,
                    studyId: 'test-study-123'
                };

                const result = await makeAPICall('/api/research-consolidated', 'POST', featureData, token);

                if (result.planLimitExceeded) {
                    addResult('success', `${feature} Test (${planType})`, 
                        `‚úÖ Feature restriction working correctly!\n\n` +
                        `Feature: ${feature}\n` +
                        `Error: ${result.error}\n` +
                        `Reason: ${result.details.reason}\n` +
                        `Required Plan: ${result.details.requiredPlan}\n` +
                        `Upgrade Message: ${result.details.upgradeMessage}`);
                } else if (result.success) {
                    addResult('success', `${feature} Test (${planType})`, 
                        `‚úÖ Feature available in ${planType} plan\n\n` +
                        `Feature: ${feature}\n` +
                        `Result: Access granted`);
                } else {
                    addResult('info', `${feature} Test (${planType})`, 
                        `‚ÑπÔ∏è Feature test result: ${result.error || 'Unknown response'}`);
                }

            } catch (error) {
                addResult('error', `${feature} Test (${planType})`, `‚ùå Test failed: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'Test';
            }
        }

        async function testAllFeatures(planType) {
            const token = TEST_TOKENS[planType];
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Testing...';

            const features = ['export-data', 'advanced-analytics', 'team-collaboration'];
            const results = [];

            try {
                for (const feature of features) {
                    const featureData = {
                        action: feature,
                        studyId: 'test-study-123'
                    };

                    const result = await makeAPICall('/api/research-consolidated', 'POST', featureData, token);
                    results.push({ feature, result });
                }

                const summary = results.map(r => {
                    if (r.result.planLimitExceeded) {
                        return `‚ùå ${r.feature}: Blocked (${r.result.details.reason})`;
                    } else if (r.result.success) {
                        return `‚úÖ ${r.feature}: Available`;
                    } else {
                        return `‚ö†Ô∏è ${r.feature}: ${r.result.error || 'Unknown'}`;
                    }
                }).join('\n');

                addResult('info', `All Features Test (${planType})`, 
                    `Feature availability for ${planType} plan:\n\n${summary}`);

            } catch (error) {
                addResult('error', `All Features Test (${planType})`, `‚ùå Test failed: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'Test All';
            }
        }

        async function testUsageStats() {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Loading...';

            try {
                const token = TEST_TOKENS.pro; // Use pro user for testing
                const result = await makeAPICall('/api/research-consolidated?action=get-usage-stats', 'GET', null, token);

                if (result.success) {
                    const { subscription, usage, usagePercentages, warningsActive } = result.data;
                    
                    // Display usage metrics
                    displayUsageMetrics(subscription, usage, usagePercentages, warningsActive);
                    
                    addResult('success', 'Usage Statistics', 
                        `‚úÖ Successfully retrieved usage stats\n\n` +
                        `Plan: ${subscription.plan}\n` +
                        `Studies Created: ${usage.studiesCreated}\n` +
                        `Participants: ${usage.participantsRecruited}\n` +
                        `Recording Minutes: ${usage.recordingMinutesUsed}\n` +
                        `Data Exports: ${usage.dataExports}\n` +
                        `Studies Usage: ${usagePercentages.studies}%\n` +
                        `Recording Usage: ${usagePercentages.recording}%`);
                } else {
                    addResult('error', 'Usage Statistics', `‚ùå Failed to get usage stats: ${result.error}`);
                }

            } catch (error) {
                addResult('error', 'Usage Statistics', `‚ùå Test failed: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'Get Stats';
            }
        }

        async function testPlanComparison() {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Loading...';

            try {
                const token = TEST_TOKENS.free; // Use free user to see upgrade options
                const result = await makeAPICall('/api/research-consolidated?action=get-plan-comparison', 'GET', null, token);

                if (result.success) {
                    const { current, available } = result.data;
                    
                    addResult('success', 'Plan Comparison', 
                        `‚úÖ Successfully retrieved plan comparison\n\n` +
                        `Current Plan: ${current.name} ($${current.price}/month)\n` +
                        `Max Studies: ${current.maxStudies === -1 ? 'Unlimited' : current.maxStudies}\n` +
                        `Max Participants: ${current.maxParticipantsPerStudy === -1 ? 'Unlimited' : current.maxParticipantsPerStudy}\n\n` +
                        `Available Upgrades:\n` +
                        available.map(plan => 
                            `‚Ä¢ ${plan.name}: $${plan.price}/month (${plan.maxStudies === -1 ? 'Unlimited' : plan.maxStudies} studies)`
                        ).join('\n'));
                } else {
                    addResult('error', 'Plan Comparison', `‚ùå Failed to get plan comparison: ${result.error}`);
                }

            } catch (error) {
                addResult('error', 'Plan Comparison', `‚ùå Test failed: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'Get Plans';
            }
        }

        function displayUsageMetrics(subscription, usage, percentages, warnings) {
            const metricsContainer = document.getElementById('usageMetrics');
            
            metricsContainer.innerHTML = `
                <div class="metric-card">
                    <div class="metric-label">Current Plan</div>
                    <div class="metric-value plan-badge plan-${subscription.plan}">${subscription.plan}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Studies Created</div>
                    <div class="metric-value">${usage.studiesCreated}</div>
                    <div class="progress-bar">
                        <div class="progress-fill ${getProgressColor(percentages.studies)}" 
                             style="width: ${Math.min(percentages.studies, 100)}%"></div>
                    </div>
                    <div class="metric-label">${percentages.studies}% of limit</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Participants</div>
                    <div class="metric-value">${usage.participantsRecruited}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Recording Minutes</div>
                    <div class="metric-value">${usage.recordingMinutesUsed}</div>
                    <div class="progress-bar">
                        <div class="progress-fill ${getProgressColor(percentages.recording)}" 
                             style="width: ${Math.min(percentages.recording, 100)}%"></div>
                    </div>
                    <div class="metric-label">${percentages.recording}% of limit</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Data Exports</div>
                    <div class="metric-value">${usage.dataExports}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Warnings</div>
                    <div class="metric-value" style="color: ${warnings.studiesNearLimit || warnings.recordingNearLimit ? '#dc3545' : '#28a745'}">
                        ${warnings.studiesNearLimit || warnings.recordingNearLimit ? '‚ö†Ô∏è' : '‚úÖ'}
                    </div>
                    <div class="metric-label">
                        ${warnings.studiesNearLimit ? 'Studies near limit' : ''}
                        ${warnings.recordingNearLimit ? 'Recording near limit' : ''}
                        ${!warnings.studiesNearLimit && !warnings.recordingNearLimit ? 'All good' : ''}
                    </div>
                </div>
            `;
            
            metricsContainer.style.display = 'grid';
        }

        function getProgressColor(percentage) {
            if (percentage > 90) return 'progress-danger';
            if (percentage > 80) return 'progress-warning';
            return 'progress-success';
        }

        function addResult(type, title, content) {
            testCounter++;
            const timestamp = new Date().toLocaleTimeString();
            const resultsContainer = document.getElementById('testResults');
            
            if (testCounter === 1) {
                resultsContainer.innerHTML = '';
            }

            const resultElement = document.createElement('div');
            resultElement.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #333;">
                        ${testCounter}. ${title} 
                        <span style="font-weight: normal; color: #666; font-size: 0.8em;">(${timestamp})</span>
                    </h4>
                    <div class="result ${type}">${content}</div>
                </div>
            `;
            
            resultsContainer.appendChild(resultElement);
            resultElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    </script>
</body>
</html>
