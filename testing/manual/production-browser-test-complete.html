<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Browser Test - JWT Fix Verification</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f5f5f5; 
        }
        .container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #007bff; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .production-badge { 
            background: #dc3545; 
            color: white; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 12px; 
            margin-left: 10px; 
        }
        .button { 
            background: #007bff; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px; 
            font-size: 16px;
        }
        .button:hover { background: #0056b3; }
        .button:disabled { background: #6c757d; cursor: not-allowed; }
        .button.large { padding: 15px 30px; font-size: 18px; }
        .results { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 4px; 
            margin: 10px 0; 
            border-left: 4px solid #007bff; 
        }
        pre { 
            background: #f1f1f1; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto; 
            max-height: 300px;
        }
        .test-section { 
            margin: 30px 0; 
            padding: 20px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            background: #fafafa;
        }
        .test-title { 
            font-size: 20px; 
            font-weight: bold; 
            margin-bottom: 15px; 
            color: #333;
        }
        .step-counter { 
            background: #007bff; 
            color: white; 
            border-radius: 50%; 
            width: 30px; 
            height: 30px; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            margin-right: 10px; 
        }
        .iframe-container { 
            border: 2px solid #007bff; 
            border-radius: 8px; 
            overflow: hidden; 
            margin: 20px 0;
        }
        iframe { 
            width: 100%; 
            height: 600px; 
            border: none; 
        }
    </style>
</head>
<body>
    <h1>üåê Production Browser Test Suite <span class="production-badge">LIVE</span></h1>
    <p class="info">Complete end-to-end testing of JWT fix on production environment: https://researchhub-saas.vercel.app</p>

    <div class="container">
        <h2>üéØ Test Overview</h2>
        <p><strong>Objective:</strong> Verify JWT parsing fix works in production browser environment</p>
        <p><strong>User Account:</strong> abwanwr77+researcher@gmail.com / Testtest123</p>
        <p><strong>Expected Behavior:</strong> Studies created should appear in researcher dashboard</p>
        <p><strong>Test Environment:</strong> Production (Live users may be affected)</p>
    </div>

    <div class="test-section">
        <div class="test-title">
            <span class="step-counter">1</span>
            Direct Production Access Test
        </div>
        <p>Test accessing the production platform directly</p>
        <button class="button large" onclick="openProductionSite()">üåê Open Production Site</button>
        <button class="button" onclick="openProductionLogin()">üîê Open Login Page</button>
        <div id="directAccessResults" class="results" style="display: none;"></div>
    </div>

    <div class="test-section">
        <div class="test-title">
            <span class="step-counter">2</span>
            Embedded Production Test
        </div>
        <p>Test production functionality within this page</p>
        <button class="button large" onclick="embedProductionSite()">üì± Embed Production Site</button>
        <button class="button" onclick="testProductionAPI()">üîß Test Production APIs</button>
        
        <div id="embeddedSite" class="iframe-container" style="display: none;">
            <!-- Production site will be embedded here -->
        </div>
        
        <div id="apiTestResults" class="results" style="display: none;"></div>
    </div>

    <div class="test-section">
        <div class="test-title">
            <span class="step-counter">3</span>
            Complete User Workflow Test
        </div>
        <p>Test the complete researcher workflow: Login ‚Üí Create Study ‚Üí Verify Persistence</p>
        <button class="button large" onclick="startCompleteWorkflowTest()">üîÑ Start Complete Test</button>
        <div id="workflowTestResults" class="results" style="display: none;"></div>
    </div>

    <div class="test-section">
        <div class="test-title">
            <span class="step-counter">4</span>
            JWT Parsing Verification
        </div>
        <p>Direct verification that JWT parsing is working correctly</p>
        <button class="button large" onclick="verifyJWTParsing()">üîë Verify JWT Parsing</button>
        <div id="jwtVerificationResults" class="results" style="display: none;"></div>
    </div>

    <div class="container">
        <h2>üìä Test Results Summary</h2>
        <div id="testSummary" class="results">
            <p class="info">Tests not yet started. Use the buttons above to begin testing.</p>
        </div>
    </div>

    <script>
        const PRODUCTION_URL = 'https://researchhub-saas.vercel.app';
        const TEST_CREDENTIALS = {
            email: 'abwanwr77+researcher@gmail.com',
            password: 'Testtest123'
        };
        const EXPECTED_USER_ID = '4c3d798b-2975-4ec4-b9e2-c6f128b8a066';

        let testResults = {
            directAccess: false,
            embedded: false,
            workflow: false,
            jwtParsing: false
        };

        function openProductionSite() {
            const resultsDiv = document.getElementById('directAccessResults');
            resultsDiv.style.display = 'block';
            
            // Open production site in new window
            const productionWindow = window.open(PRODUCTION_URL, '_blank', 'width=1200,height=800');
            
            resultsDiv.innerHTML = `
                <p class="success">‚úÖ Production site opened in new window</p>
                <p><strong>URL:</strong> <a href="${PRODUCTION_URL}" target="_blank">${PRODUCTION_URL}</a></p>
                <p><strong>Instructions:</strong></p>
                <ol>
                    <li>Login with: ${TEST_CREDENTIALS.email}</li>
                    <li>Navigate to Studies or Dashboard</li>
                    <li>Try creating a new study</li>
                    <li>Verify the study appears in your dashboard</li>
                    <li>Return here to report results</li>
                </ol>
                <p class="info">üí° If studies appear correctly, the JWT fix is working!</p>
            `;
            
            testResults.directAccess = true;
            updateTestSummary();
        }

        function openProductionLogin() {
            const loginUrl = `${PRODUCTION_URL}/login`;
            window.open(loginUrl, '_blank', 'width=1000,height=700');
            
            const resultsDiv = document.getElementById('directAccessResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <p class="success">‚úÖ Login page opened</p>
                <p><strong>Login URL:</strong> <a href="${loginUrl}" target="_blank">${loginUrl}</a></p>
                <p><strong>Test Credentials:</strong> ${TEST_CREDENTIALS.email} / ${TEST_CREDENTIALS.password}</p>
            `;
        }

        function embedProductionSite() {
            const embeddedDiv = document.getElementById('embeddedSite');
            embeddedDiv.style.display = 'block';
            embeddedDiv.innerHTML = `
                <iframe src="${PRODUCTION_URL}" title="Production ResearchHub"></iframe>
            `;
            
            testResults.embedded = true;
            updateTestSummary();
        }

        async function testProductionAPI() {
            const resultsDiv = document.getElementById('apiTestResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<p class="info">Testing production APIs...</p>';

            try {
                // Test health endpoint
                const healthResponse = await fetch(`${PRODUCTION_URL}/api/health`);
                const healthData = await healthResponse.json();
                
                let html = '<h4>Production API Test Results</h4>';
                
                if (healthData.success) {
                    html += `<p class="success">‚úÖ Health API: Working</p>`;
                    html += `<p><strong>Environment:</strong> ${healthData.environment}</p>`;
                    html += `<p><strong>Version:</strong> ${healthData.version}</p>`;
                    
                    // Test authentication
                    try {
                        const authResponse = await fetch(`${PRODUCTION_URL}/api/auth-consolidated?action=login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(TEST_CREDENTIALS)
                        });
                        
                        const authData = await authResponse.json();
                        
                        if (authData.success && authData.session?.access_token) {
                            html += `<p class="success">‚úÖ Authentication API: Working</p>`;
                            html += `<p><strong>User ID:</strong> ${authData.user?.id}</p>`;
                            html += `<p><strong>Expected ID:</strong> ${EXPECTED_USER_ID}</p>`;
                            html += `<p><strong>Match:</strong> ${authData.user?.id === EXPECTED_USER_ID ? '‚úÖ YES' : '‚ùå NO'}</p>`;
                            
                            // Test JWT parsing
                            const token = authData.session.access_token;
                            try {
                                const payload = JSON.parse(atob(token.split('.')[1]));
                                html += `<p class="success">‚úÖ JWT Parsing: Working in browser</p>`;
                                html += `<p><strong>JWT User ID:</strong> ${payload.sub}</p>`;
                                testResults.jwtParsing = true;
                            } catch (jwtError) {
                                html += `<p class="error">‚ùå JWT Parsing: Failed (${jwtError.message})</p>`;
                            }
                            
                        } else {
                            html += `<p class="error">‚ùå Authentication API: Failed</p>`;
                        }
                    } catch (authError) {
                        html += `<p class="error">‚ùå Authentication API: Error (${authError.message})</p>`;
                    }
                    
                } else {
                    html += `<p class="error">‚ùå Health API: Failed</p>`;
                }

                resultsDiv.innerHTML = html;
                updateTestSummary();
                
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">‚ùå API test failed: ${error.message}</p>`;
            }
        }

        async function startCompleteWorkflowTest() {
            const resultsDiv = document.getElementById('workflowTestResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<p class="info">Starting complete workflow test...</p>';

            try {
                let html = '<h4>Complete Workflow Test Progress</h4>';
                
                // Step 1: Login
                html += '<p class="info">üîÑ Step 1: Authenticating...</p>';
                resultsDiv.innerHTML = html;
                
                const authResponse = await fetch(`${PRODUCTION_URL}/api/auth-consolidated?action=login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(TEST_CREDENTIALS)
                });
                
                const authData = await authResponse.json();
                
                if (!authData.success || !authData.session?.access_token) {
                    html += '<p class="error">‚ùå Step 1 Failed: Authentication failed</p>';
                    resultsDiv.innerHTML = html;
                    return;
                }
                
                html += '<p class="success">‚úÖ Step 1: Authentication successful</p>';
                const token = authData.session.access_token;
                const userId = authData.user?.id;
                
                // Step 2: Create Study
                html += '<p class="info">üîÑ Step 2: Creating test study...</p>';
                resultsDiv.innerHTML = html;
                
                const studyData = {
                    title: `Browser Test Study ${new Date().toLocaleTimeString()}`,
                    description: 'Testing complete workflow in browser',
                    type: 'usability',
                    status: 'active',
                    target_participants: 3,
                    blocks: [
                        {
                            type: 'welcome',
                            title: 'Browser Test Welcome',
                            description: 'Testing from browser interface',
                            settings: {}
                        }
                    ]
                };
                
                try {
                    const createResponse = await fetch(`${PRODUCTION_URL}/api/research-consolidated?action=create-study`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(studyData)
                    });
                    
                    const createData = await createResponse.json();
                    
                    if (createData.success && (createData.data?.id || createData.study?.id)) {
                        const studyId = createData.data?.id || createData.study?.id;
                        const study = createData.data || createData.study;
                        
                        html += '<p class="success">‚úÖ Step 2: Study created successfully</p>';
                        html += `<p><strong>Study ID:</strong> ${studyId}</p>`;
                        html += `<p><strong>Creator ID:</strong> ${study.creator_id || study.created_by}</p>`;
                        html += `<p><strong>Expected:</strong> ${EXPECTED_USER_ID}</p>`;
                        
                        // Step 3: Verify study appears in dashboard
                        html += '<p class="info">üîÑ Step 3: Checking study persistence...</p>';
                        resultsDiv.innerHTML = html;
                        
                        try {
                            const getResponse = await fetch(`${PRODUCTION_URL}/api/research-consolidated?action=get-studies`, {
                                method: 'GET',
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            
                            const getData = await getResponse.json();
                            
                            if (getData.success && (getData.data || getData.studies)) {
                                const studies = getData.data || getData.studies;
                                const ourStudy = studies.find(s => s.id === studyId);
                                
                                if (ourStudy) {
                                    html += '<p class="success">‚úÖ Step 3: Study persistence verified!</p>';
                                    html += `<p class="success">üéâ COMPLETE WORKFLOW SUCCESS!</p>`;
                                    html += `<p><strong>Total Studies:</strong> ${studies.length}</p>`;
                                    html += `<p><strong>Study Found:</strong> ${ourStudy.title}</p>`;
                                    testResults.workflow = true;
                                } else {
                                    html += '<p class="error">‚ùå Step 3: Study not found in dashboard</p>';
                                }
                            } else {
                                html += '<p class="error">‚ùå Step 3: Failed to retrieve studies</p>';
                            }
                        } catch (getError) {
                            html += `<p class="error">‚ùå Step 3: Error retrieving studies (${getError.message})</p>`;
                        }
                        
                    } else {
                        html += '<p class="error">‚ùå Step 2: Study creation failed</p>';
                        html += `<pre>${JSON.stringify(createData, null, 2)}</pre>`;
                    }
                } catch (createError) {
                    html += `<p class="error">‚ùå Step 2: Study creation error (${createError.message})</p>`;
                }
                
                resultsDiv.innerHTML = html;
                updateTestSummary();
                
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">‚ùå Workflow test failed: ${error.message}</p>`;
            }
        }

        async function verifyJWTParsing() {
            const resultsDiv = document.getElementById('jwtVerificationResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<p class="info">Verifying JWT parsing functionality...</p>';

            try {
                // Get JWT token
                const authResponse = await fetch(`${PRODUCTION_URL}/api/auth-consolidated?action=login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(TEST_CREDENTIALS)
                });
                
                const authData = await authResponse.json();
                
                let html = '<h4>JWT Parsing Verification Results</h4>';
                
                if (authData.success && authData.session?.access_token) {
                    const token = authData.session.access_token;
                    
                    try {
                        // Parse JWT in browser
                        const parts = token.split('.');
                        const header = JSON.parse(atob(parts[0]));
                        const payload = JSON.parse(atob(parts[1]));
                        
                        html += `<p class="success">‚úÖ JWT parsing successful in browser</p>`;
                        html += `<p><strong>Token Parts:</strong> ${parts.length} (Header, Payload, Signature)</p>`;
                        html += `<p><strong>Algorithm:</strong> ${header.alg}</p>`;
                        html += `<p><strong>User ID:</strong> ${payload.sub}</p>`;
                        html += `<p><strong>Email:</strong> ${payload.email}</p>`;
                        html += `<p><strong>Role:</strong> ${payload.role || payload.user_metadata?.role}</p>`;
                        html += `<p><strong>Expected ID:</strong> ${EXPECTED_USER_ID}</p>`;
                        html += `<p><strong>ID Match:</strong> ${payload.sub === EXPECTED_USER_ID ? '‚úÖ CORRECT' : '‚ùå INCORRECT'}</p>`;
                        
                        if (payload.sub === EXPECTED_USER_ID) {
                            html += `<p class="success">üéâ JWT parsing fix confirmed working!</p>`;
                            testResults.jwtParsing = true;
                        }
                        
                        html += `<details><summary>Full JWT Payload</summary><pre>${JSON.stringify(payload, null, 2)}</pre></details>`;
                        
                    } catch (parseError) {
                        html += `<p class="error">‚ùå JWT parsing failed: ${parseError.message}</p>`;
                    }
                } else {
                    html += `<p class="error">‚ùå Failed to obtain JWT token</p>`;
                }

                resultsDiv.innerHTML = html;
                updateTestSummary();
                
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">‚ùå JWT verification failed: ${error.message}</p>`;
            }
        }

        function updateTestSummary() {
            const summaryDiv = document.getElementById('testSummary');
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(result => result).length;
            
            let html = `<h4>üèÜ Browser Test Results Summary</h4>`;
            html += `<p><strong>Tests Completed:</strong> ${passedTests}/${totalTests}</p>`;
            
            Object.entries(testResults).forEach(([test, passed]) => {
                const emoji = passed ? '‚úÖ' : '‚è≥';
                const status = passed ? 'COMPLETED' : 'PENDING';
                const testName = test.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                html += `<p>${emoji} ${testName}: ${status}</p>`;
            });

            if (passedTests === totalTests && testResults.workflow && testResults.jwtParsing) {
                html += `
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; padding: 15px; margin: 15px 0;">
                        <p class="success">üéâ ALL TESTS PASSED!</p>
                        <p class="success">‚úÖ JWT fix is working perfectly in production!</p>
                        <p class="success">‚úÖ Complete user workflow functional!</p>
                        <p class="success">‚úÖ Study persistence confirmed working!</p>
                    </div>
                `;
            } else if (passedTests > 0) {
                html += `<p class="warning">‚ö†Ô∏è Some tests completed - continue testing for full verification</p>`;
            } else {
                html += `<p class="info">üìã Ready to start testing - use buttons above</p>`;
            }

            summaryDiv.innerHTML = html;
        }

        // Initialize
        updateTestSummary();
    </script>
</body>
</html>
