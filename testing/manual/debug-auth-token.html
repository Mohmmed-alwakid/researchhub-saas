<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Token Debug - ResearchHub</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .token-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }
        .test-results {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>üîê Authentication Token Debugger</h1>
    
    <div class="debug-panel">
        <h3>Current Authentication State</h3>
        <div id="authStatus"></div>
        <button onclick="checkAuthState()">Check Current Auth State</button>
        <button onclick="testTokenValidity()">Test Token Validity</button>
        <button onclick="clearAuth()">Clear All Auth Data</button>
    </div>

    <div class="debug-panel">
        <h3>Token Information</h3>
        <div id="tokenInfo"></div>
    </div>

    <div class="debug-panel">
        <h3>API Test Results</h3>
        <div id="apiResults"></div>
        <button onclick="testCreateStudyAPI()">Test Create Study API</button>
        <button onclick="testAllAPIs()">Test All Research APIs</button>
    </div>

    <div class="debug-panel">
        <h3>Login Test</h3>
        <div style="margin-bottom: 10px;">
            <label>Email: </label>
            <input type="email" id="testEmail" value="abwanwr77+Researcher@gmail.com" style="width: 300px; padding: 5px;">
        </div>
        <div style="margin-bottom: 10px;">
            <label>Password: </label>
            <input type="password" id="testPassword" value="Testtest123" style="width: 300px; padding: 5px;">
        </div>
        <button onclick="testLogin()">Test Login</button>
        <div id="loginResults"></div>
    </div>

    <script>
        const API_BASE = 'https://researchhub-saas.vercel.app/api';

        function displayStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function checkAuthState() {
            const authStorage = localStorage.getItem('auth-storage');
            let statusMessage = '';
            
            if (!authStorage) {
                statusMessage = '‚ùå No authentication data found in localStorage';
                displayStatus('authStatus', statusMessage, 'error');
                document.getElementById('tokenInfo').innerHTML = '<div class="status error">No token data available</div>';
                return;
            }

            try {
                const { state } = JSON.parse(authStorage);
                const user = state?.user;
                const token = state?.token;
                const refreshToken = state?.refreshToken;

                statusMessage = `‚úÖ Authentication data found:<br>
                    ‚Ä¢ User: ${user?.email || 'Unknown'}<br>
                    ‚Ä¢ Role: ${user?.role || 'Unknown'}<br>
                    ‚Ä¢ User ID: ${user?.id || 'Unknown'}<br>
                    ‚Ä¢ Has Token: ${token ? 'Yes' : 'No'}<br>
                    ‚Ä¢ Has Refresh Token: ${refreshToken ? 'Yes' : 'No'}`;
                
                displayStatus('authStatus', statusMessage, 'success');

                // Display token information
                if (token) {
                    let tokenInfo = `<strong>Access Token:</strong><br><div class="token-display">${token}</div><br>`;
                    
                    // Try to decode JWT
                    try {
                        if (token.includes('.')) {
                            const payload = JSON.parse(atob(token.split('.')[1]));
                            const now = Math.floor(Date.now() / 1000);
                            const isExpired = payload.exp <= now;
                            const expiresIn = payload.exp - now;
                            
                            tokenInfo += `<strong>Token Details:</strong><br>
                                ‚Ä¢ Issued At: ${new Date(payload.iat * 1000).toLocaleString()}<br>
                                ‚Ä¢ Expires At: ${new Date(payload.exp * 1000).toLocaleString()}<br>
                                ‚Ä¢ Time Until Expiry: ${expiresIn > 0 ? Math.floor(expiresIn / 60) + ' minutes' : 'EXPIRED'}<br>
                                ‚Ä¢ Status: ${isExpired ? 'üî¥ EXPIRED' : 'üü¢ VALID'}<br>
                                ‚Ä¢ Subject: ${payload.sub || 'Unknown'}<br>
                                ‚Ä¢ Role: ${payload.role || 'Not specified'}`;
                        } else {
                            tokenInfo += '<strong>Token Type:</strong> Non-JWT (possibly fallback token)';
                        }
                    } catch (e) {
                        tokenInfo += '<strong>Token Type:</strong> Cannot decode (invalid JWT format)';
                    }

                    if (refreshToken) {
                        tokenInfo += `<br><br><strong>Refresh Token:</strong><br><div class="token-display">${refreshToken}</div>`;
                    }

                    document.getElementById('tokenInfo').innerHTML = tokenInfo;
                } else {
                    document.getElementById('tokenInfo').innerHTML = '<div class="status error">No access token found</div>';
                }

            } catch (e) {
                statusMessage = `‚ùå Invalid authentication data format: ${e.message}`;
                displayStatus('authStatus', statusMessage, 'error');
            }
        }

        async function testTokenValidity() {
            const authStorage = localStorage.getItem('auth-storage');
            if (!authStorage) {
                displayStatus('authStatus', '‚ùå No authentication data to test', 'error');
                return;
            }

            try {
                const { state } = JSON.parse(authStorage);
                const token = state?.token;

                if (!token) {
                    displayStatus('authStatus', '‚ùå No token found to test', 'error');
                    return;
                }

                // Test token with a simple API call
                const response = await fetch(`${API_BASE}/research-consolidated?action=get-studies`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.text();
                let data;
                try {
                    data = JSON.parse(result);
                } catch {
                    data = { rawResponse: result };
                }

                if (response.ok) {
                    displayStatus('authStatus', `‚úÖ Token is valid! API responded with status ${response.status}`, 'success');
                } else {
                    displayStatus('authStatus', `‚ùå Token validation failed: ${response.status} - ${data.error || data.rawResponse || 'Unknown error'}`, 'error');
                }

            } catch (error) {
                displayStatus('authStatus', `‚ùå Token validation error: ${error.message}`, 'error');
            }
        }

        async function testCreateStudyAPI() {
            const authStorage = localStorage.getItem('auth-storage');
            if (!authStorage) {
                displayStatus('apiResults', '‚ùå No authentication data available', 'error');
                return;
            }

            try {
                const { state } = JSON.parse(authStorage);
                const token = state?.token;

                if (!token) {
                    displayStatus('apiResults', '‚ùå No token found', 'error');
                    return;
                }

                const testStudyData = {
                    title: 'Debug Test Study',
                    description: 'Test study created for debugging authentication',
                    status: 'draft',
                    type: 'usability',
                    target_participants: 5,
                    blocks: []
                };

                console.log('üß™ Testing create study API with token:', token.substring(0, 20) + '...');

                const response = await fetch(`${API_BASE}/research-consolidated?action=create-study`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testStudyData)
                });

                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch {
                    data = { rawResponse: responseText };
                }

                let resultMessage = `<strong>Create Study API Test Result:</strong><br>
                    ‚Ä¢ Status: ${response.status}<br>
                    ‚Ä¢ Success: ${response.ok ? '‚úÖ YES' : '‚ùå NO'}<br>
                    ‚Ä¢ Response: <div class="token-display">${JSON.stringify(data, null, 2)}</div>`;

                displayStatus('apiResults', resultMessage, response.ok ? 'success' : 'error');

            } catch (error) {
                displayStatus('apiResults', `‚ùå API test error: ${error.message}`, 'error');
            }
        }

        async function testLogin() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;

            if (!email || !password) {
                displayStatus('loginResults', '‚ùå Please enter email and password', 'error');
                return;
            }

            try {
                displayStatus('loginResults', 'üîÑ Testing login...', 'info');

                const response = await fetch(`${API_BASE}/auth-consolidated?action=login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Store the authentication data
                    const authState = {
                        user: data.user,
                        token: data.session?.access_token || data.tokens?.authToken,
                        refreshToken: data.session?.refresh_token || data.tokens?.refreshToken,
                        isAuthenticated: true
                    };

                    localStorage.setItem('auth-storage', JSON.stringify({ 
                        state: authState, 
                        version: 0 
                    }));

                    displayStatus('loginResults', `‚úÖ Login successful!<br>
                        ‚Ä¢ User: ${data.user?.email}<br>
                        ‚Ä¢ Role: ${data.user?.role}<br>
                        ‚Ä¢ Token received: ${authState.token ? 'Yes' : 'No'}`, 'success');
                    
                    // Refresh the auth state display
                    checkAuthState();
                } else {
                    displayStatus('loginResults', `‚ùå Login failed: ${data.message || 'Unknown error'}`, 'error');
                }

            } catch (error) {
                displayStatus('loginResults', `‚ùå Login error: ${error.message}`, 'error');
            }
        }

        async function testAllAPIs() {
            const authStorage = localStorage.getItem('auth-storage');
            if (!authStorage) {
                displayStatus('apiResults', '‚ùå No authentication data available', 'error');
                return;
            }

            const { state } = JSON.parse(authStorage);
            const token = state?.token;

            if (!token) {
                displayStatus('apiResults', '‚ùå No token found', 'error');
                return;
            }

            const apiTests = [
                { name: 'Get Studies', url: `${API_BASE}/research-consolidated?action=get-studies`, method: 'GET' },
                { name: 'Dashboard Analytics', url: `${API_BASE}/research-consolidated?action=dashboard-analytics`, method: 'GET' },
                { name: 'Health Check', url: `${API_BASE}/health`, method: 'GET' }
            ];

            let results = '<strong>API Test Results:</strong><br>';

            for (const test of apiTests) {
                try {
                    const response = await fetch(test.url, {
                        method: test.method,
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const success = response.ok;
                    results += `‚Ä¢ ${test.name}: ${success ? '‚úÖ SUCCESS' : '‚ùå FAILED'} (${response.status})<br>`;

                } catch (error) {
                    results += `‚Ä¢ ${test.name}: ‚ùå ERROR - ${error.message}<br>`;
                }
            }

            displayStatus('apiResults', results, 'info');
        }

        function clearAuth() {
            localStorage.removeItem('auth-storage');
            displayStatus('authStatus', '‚úÖ Authentication data cleared', 'success');
            document.getElementById('tokenInfo').innerHTML = '<div class="status info">Authentication data cleared</div>';
        }

        // Initialize on page load
        checkAuthState();
    </script>
</body>
</html>
