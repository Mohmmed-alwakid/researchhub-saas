<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Template Creation Authentication Integration Test</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f7fa;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e1e5e9;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #e1e5e9;
      border-radius: 6px;
      background-color: #fdfdfd;
    }
    .test-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .test-item {
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
    }
    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    .status.pending { background-color: #fff3cd; color: #856404; }
    .status.success { background-color: #d4edda; color: #155724; }
    .status.error { background-color: #f8d7da; color: #721c24; }
    .status.info { background-color: #d1ecf1; color: #0c5460; }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover { background-color: #0056b3; }
    button:disabled { 
      background-color: #6c757d; 
      cursor: not-allowed; 
    }
    .btn-danger {
      background-color: #dc3545;
    }
    .btn-danger:hover {
      background-color: #c82333;
    }
    .btn-success {
      background-color: #28a745;
    }
    .btn-success:hover {
      background-color: #218838;
    }
    .response-box {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin-top: 10px;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    .auth-info {
      background-color: #e7f3ff;
      border: 1px solid #b3d7ff;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .test-scenario {
      border-left: 4px solid #007bff;
      padding-left: 15px;
      margin-bottom: 15px;
    }
    .role-indicator {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
    }
    .role-researcher { background-color: #28a745; color: white; }
    .role-participant { background-color: #ffc107; color: #212529; }
    .role-admin { background-color: #dc3545; color: white; }
    .role-none { background-color: #6c757d; color: white; }
    .endpoint-group {
      margin-bottom: 25px;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      overflow: hidden;
    }
    .endpoint-header {
      background-color: #f8f9fa;
      padding: 10px 15px;
      border-bottom: 1px solid #dee2e6;
      font-weight: bold;
    }
    .endpoint-body {
      padding: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîê Template Creation Authentication Integration Test</h1>
      <p>Comprehensive testing of Template Creation UI with role-based authentication</p>
      <div id="authStatus" class="auth-info">
        <strong>Authentication Status:</strong> <span id="authStatusText">Not checked</span>
        <span id="userRole" class="role-indicator role-none">No Auth</span>
      </div>
    </div>

    <!-- Authentication Tests -->
    <div class="section">
      <h2>üîë Authentication Testing</h2>
      <div class="test-group">
        <div class="test-item">
          <h4>Login Test Account</h4>
          <p>Login as researcher to test template creation</p>
          <button onclick="loginAsResearcher()">Login as Researcher</button>
          <button onclick="loginAsParticipant()">Login as Participant</button>
          <button onclick="loginAsAdmin()">Login as Admin</button>
          <button onclick="logout()" class="btn-danger">Logout</button>
          <div id="authResponse" class="response-box" style="display: none;"></div>
        </div>

        <div class="test-item">
          <h4>Check Auth Status</h4>
          <p>Verify current authentication state</p>
          <button onclick="checkAuthStatus()">Check Status</button>
          <div id="authCheckResponse" class="response-box" style="display: none;"></div>
        </div>
      </div>
    </div>

    <!-- Template API Tests -->
    <div class="section">
      <h2>üìã Template API Authentication Tests</h2>
      
      <div class="endpoint-group">
        <div class="endpoint-header">GET /api/templates - List Templates</div>
        <div class="endpoint-body">
          <div class="test-scenario">
            <h5>Scenario: Public access (should work without auth)</h5>
            <button onclick="testGetTemplates(false)">Test Without Auth</button>
            <button onclick="testGetTemplates(true)">Test With Auth</button>
            <div id="getTemplatesResponse" class="response-box" style="display: none;"></div>
          </div>
        </div>
      </div>

      <div class="endpoint-group">
        <div class="endpoint-header">GET /api/templates?action=categories - Get Categories</div>
        <div class="endpoint-body">
          <div class="test-scenario">
            <h5>Scenario: Public access (should work without auth)</h5>
            <button onclick="testGetCategories()">Test Categories</button>
            <div id="getCategoriesResponse" class="response-box" style="display: none;"></div>
          </div>
        </div>
      </div>

      <div class="endpoint-group">
        <div class="endpoint-header">POST /api/templates - Create Template</div>
        <div class="endpoint-body">
          <div class="test-scenario">
            <h5>Scenario: Researchers/Admin only</h5>
            <button onclick="testCreateTemplate(false)">Test Without Auth</button>
            <button onclick="testCreateTemplate(true)">Test With Auth</button>
            <div id="createTemplateResponse" class="response-box" style="display: none;"></div>
          </div>
        </div>
      </div>

      <div class="endpoint-group">
        <div class="endpoint-header">PUT /api/templates/:id - Update Template</div>
        <div class="endpoint-body">
          <div class="test-scenario">
            <h5>Scenario: Creator/Admin only</h5>
            <button onclick="testUpdateTemplate(false)">Test Without Auth</button>
            <button onclick="testUpdateTemplate(true)">Test With Auth</button>
            <div id="updateTemplateResponse" class="response-box" style="display: none;"></div>
          </div>
        </div>
      </div>

      <div class="endpoint-group">
        <div class="endpoint-header">DELETE /api/templates/:id - Delete Template</div>
        <div class="endpoint-body">
          <div class="test-scenario">
            <h5>Scenario: Creator/Admin only</h5>
            <button onclick="testDeleteTemplate(false)">Test Without Auth</button>
            <button onclick="testDeleteTemplate(true)">Test With Auth</button>
            <div id="deleteTemplateResponse" class="response-box" style="display: none;"></div>
          </div>
        </div>
      </div>

      <div class="endpoint-group">
        <div class="endpoint-header">POST /api/templates/:id/duplicate - Duplicate Template</div>
        <div class="endpoint-body">
          <div class="test-scenario">
            <h5>Scenario: Researchers/Admin only</h5>
            <button onclick="testDuplicateTemplate(false)">Test Without Auth</button>
            <button onclick="testDuplicateTemplate(true)">Test With Auth</button>
            <div id="duplicateTemplateResponse" class="response-box" style="display: none;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Role-Based Access Tests -->
    <div class="section">
      <h2>üë• Role-Based Access Testing</h2>
      <div class="test-group">
        <div class="test-item">
          <h4>Researcher Role Tests</h4>
          <p>Test template creation as researcher</p>
          <button onclick="testResearcherAccess()">Test Researcher Access</button>
          <div id="researcherResponse" class="response-box" style="display: none;"></div>
        </div>

        <div class="test-item">
          <h4>Participant Role Tests</h4>
          <p>Test template access as participant (should be denied)</p>
          <button onclick="testParticipantAccess()">Test Participant Access</button>
          <div id="participantResponse" class="response-box" style="display: none;"></div>
        </div>

        <div class="test-item">
          <h4>Admin Role Tests</h4>
          <p>Test template access as admin (should have full access)</p>
          <button onclick="testAdminAccess()">Test Admin Access</button>
          <div id="adminResponse" class="response-box" style="display: none;"></div>
        </div>
      </div>
    </div>

    <!-- Template Creation UI Integration -->
    <div class="section">
      <h2>üé® Template Creation UI Integration</h2>
      <div class="test-group">
        <div class="test-item">
          <h4>UI Authentication Checks</h4>
          <p>Test how the UI responds to different auth states</p>
          <button onclick="testUIAuthStates()">Test UI Auth States</button>
          <div id="uiAuthResponse" class="response-box" style="display: none;"></div>
        </div>

        <div class="test-item">
          <h4>Form Submission Tests</h4>
          <p>Test template form submission with auth</p>
          <button onclick="testFormSubmission()">Test Form Submission</button>
          <div id="formResponse" class="response-box" style="display: none;"></div>
        </div>
      </div>
    </div>

    <!-- Test Summary -->
    <div class="section">
      <h2>üìä Test Summary</h2>
      <div id="testSummary">
        <p>Run tests above to see summary...</p>
      </div>
      <button onclick="runAllTests()" class="btn-success">Run All Tests</button>
      <button onclick="clearResults()" class="btn-danger">Clear Results</button>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3003';
    let currentUser = null;
    let currentToken = null;
    let testResults = [];

    // Authentication functions
    async function loginAsResearcher() {
      await login('abwanwr77+Researcher@gmail.com', 'Testtest123', 'researcher');
    }

    async function loginAsParticipant() {
      await login('abwanwr77+participant@gmail.com', 'Testtest123', 'participant');
    }

    async function loginAsAdmin() {
      await login('abwanwr77+admin@gmail.com', 'Testtest123', 'admin');
    }

    async function login(email, password, expectedRole) {
      try {
        showResponse('authResponse', 'Attempting login...', 'pending');
        
        const response = await fetch(`${API_BASE}/api/auth?action=login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, password })
        });

        const result = await response.json();
        showResponse('authResponse', JSON.stringify(result, null, 2), response.ok ? 'success' : 'error');

        if (result.success && result.user) {
          currentUser = result.user;
          currentToken = result.session?.access_token || result.tokens?.authToken;
          updateAuthStatus(result.user);
          recordTestResult(`Login as ${expectedRole}`, true, `Successfully logged in as ${result.user.role}`);
        } else {
          recordTestResult(`Login as ${expectedRole}`, false, result.message || 'Login failed');
        }
      } catch (error) {
        showResponse('authResponse', `Error: ${error.message}`, 'error');
        recordTestResult(`Login as ${expectedRole}`, false, error.message);
      }
    }

    async function logout() {
      try {
        if (currentToken) {
          await fetch(`${API_BASE}/api/auth?action=logout`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${currentToken}`
            }
          });
        }
        
        currentUser = null;
        currentToken = null;
        updateAuthStatus(null);
        showResponse('authResponse', 'Logged out successfully', 'success');
        recordTestResult('Logout', true, 'Successfully logged out');
      } catch (error) {
        showResponse('authResponse', `Logout error: ${error.message}`, 'error');
        recordTestResult('Logout', false, error.message);
      }
    }

    async function checkAuthStatus() {
      try {
        const headers = { 'Content-Type': 'application/json' };
        if (currentToken) {
          headers.Authorization = `Bearer ${currentToken}`;
        }

        const response = await fetch(`${API_BASE}/api/auth?action=status`, {
          headers
        });

        const result = await response.json();
        showResponse('authCheckResponse', JSON.stringify(result, null, 2), response.ok ? 'success' : 'error');
        
        if (result.success && result.user) {
          updateAuthStatus(result.user);
          recordTestResult('Auth Status Check', true, `User: ${result.user.email}, Role: ${result.user.role}`);
        } else {
          recordTestResult('Auth Status Check', false, result.message || 'No valid session');
        }
      } catch (error) {
        showResponse('authCheckResponse', `Error: ${error.message}`, 'error');
        recordTestResult('Auth Status Check', false, error.message);
      }
    }

    // Template API tests
    async function testGetTemplates(withAuth) {
      try {
        const headers = { 'Content-Type': 'application/json' };
        if (withAuth && currentToken) {
          headers.Authorization = `Bearer ${currentToken}`;
        }

        const response = await fetch(`${API_BASE}/api/templates`, { headers });
        const result = await response.json();
        
        showResponse('getTemplatesResponse', JSON.stringify(result, null, 2), response.ok ? 'success' : 'error');
        recordTestResult(`Get Templates ${withAuth ? 'with' : 'without'} auth`, response.ok, `Status: ${response.status}, Templates: ${result.data?.length || 0}`);
      } catch (error) {
        showResponse('getTemplatesResponse', `Error: ${error.message}`, 'error');
        recordTestResult(`Get Templates ${withAuth ? 'with' : 'without'} auth`, false, error.message);
      }
    }

    async function testGetCategories() {
      try {
        const response = await fetch(`${API_BASE}/api/templates?action=categories`);
        const result = await response.json();
        
        showResponse('getCategoriesResponse', JSON.stringify(result, null, 2), response.ok ? 'success' : 'error');
        recordTestResult('Get Categories', response.ok, `Status: ${response.status}, Categories: ${result.data?.length || 0}`);
      } catch (error) {
        showResponse('getCategoriesResponse', `Error: ${error.message}`, 'error');
        recordTestResult('Get Categories', false, error.message);
      }
    }

    async function testCreateTemplate(withAuth) {
      try {
        const templateData = {
          name: 'Test Template Auth',
          description: 'Template created for authentication testing',
          category: 'usability-testing',
          blocks: [
            { type: 'welcome_screen', settings: { title: 'Welcome' } },
            { type: 'thank_you', settings: { title: 'Thank you' } }
          ],
          tags: ['test', 'auth'],
          isPublic: false
        };

        const headers = { 'Content-Type': 'application/json' };
        if (withAuth && currentToken) {
          headers.Authorization = `Bearer ${currentToken}`;
        }

        const response = await fetch(`${API_BASE}/api/templates`, {
          method: 'POST',
          headers,
          body: JSON.stringify(templateData)
        });

        const result = await response.json();
        showResponse('createTemplateResponse', JSON.stringify(result, null, 2), response.ok ? 'success' : 'error');
        
        const expectedSuccess = withAuth && currentUser && ['researcher', 'admin'].includes(currentUser.role);
        recordTestResult(`Create Template ${withAuth ? 'with' : 'without'} auth`, response.ok === expectedSuccess, 
          `Status: ${response.status}, Expected: ${expectedSuccess ? 'success' : 'failure'}`);
      } catch (error) {
        showResponse('createTemplateResponse', `Error: ${error.message}`, 'error');
        recordTestResult(`Create Template ${withAuth ? 'with' : 'without'} auth`, false, error.message);
      }
    }

    async function testUpdateTemplate(withAuth) {
      try {
        const templateData = {
          name: 'Updated Test Template',
          description: 'Updated for authentication testing',
          category: 'usability-testing'
        };

        const headers = { 'Content-Type': 'application/json' };
        if (withAuth && currentToken) {
          headers.Authorization = `Bearer ${currentToken}`;
        }

        const response = await fetch(`${API_BASE}/api/templates/template_usability_basic`, {
          method: 'PUT',
          headers,
          body: JSON.stringify(templateData)
        });

        const result = await response.json();
        showResponse('updateTemplateResponse', JSON.stringify(result, null, 2), response.ok ? 'success' : 'error');
        
        const expectedSuccess = withAuth && currentUser && ['researcher', 'admin'].includes(currentUser.role);
        recordTestResult(`Update Template ${withAuth ? 'with' : 'without'} auth`, response.ok === expectedSuccess,
          `Status: ${response.status}, Expected: ${expectedSuccess ? 'success' : 'failure'}`);
      } catch (error) {
        showResponse('updateTemplateResponse', `Error: ${error.message}`, 'error');
        recordTestResult(`Update Template ${withAuth ? 'with' : 'without'} auth`, false, error.message);
      }
    }

    async function testDeleteTemplate(withAuth) {
      try {
        const headers = {};
        if (withAuth && currentToken) {
          headers.Authorization = `Bearer ${currentToken}`;
        }

        const response = await fetch(`${API_BASE}/api/templates/template_test_delete`, {
          method: 'DELETE',
          headers
        });

        const result = await response.json();
        showResponse('deleteTemplateResponse', JSON.stringify(result, null, 2), response.ok ? 'success' : 'error');
        
        const expectedSuccess = withAuth && currentUser && ['researcher', 'admin'].includes(currentUser.role);
        recordTestResult(`Delete Template ${withAuth ? 'with' : 'without'} auth`, response.ok === expectedSuccess,
          `Status: ${response.status}, Expected: ${expectedSuccess ? 'success' : 'failure'}`);
      } catch (error) {
        showResponse('deleteTemplateResponse', `Error: ${error.message}`, 'error');
        recordTestResult(`Delete Template ${withAuth ? 'with' : 'without'} auth`, false, error.message);
      }
    }

    async function testDuplicateTemplate(withAuth) {
      try {
        const headers = {};
        if (withAuth && currentToken) {
          headers.Authorization = `Bearer ${currentToken}`;
        }

        const response = await fetch(`${API_BASE}/api/templates/template_usability_basic/duplicate`, {
          method: 'POST',
          headers
        });

        const result = await response.json();
        showResponse('duplicateTemplateResponse', JSON.stringify(result, null, 2), response.ok ? 'success' : 'error');
        
        const expectedSuccess = withAuth && currentUser && ['researcher', 'admin'].includes(currentUser.role);
        recordTestResult(`Duplicate Template ${withAuth ? 'with' : 'without'} auth`, response.ok === expectedSuccess,
          `Status: ${response.status}, Expected: ${expectedSuccess ? 'success' : 'failure'}`);
      } catch (error) {
        showResponse('duplicateTemplateResponse', `Error: ${error.message}`, 'error');
        recordTestResult(`Duplicate Template ${withAuth ? 'with' : 'without'} auth`, false, error.message);
      }
    }

    // Role-based access tests
    async function testResearcherAccess() {
      if (currentUser?.role !== 'researcher') {
        showResponse('researcherResponse', 'Please login as researcher first', 'error');
        return;
      }

      const results = [];
      
      // Test template creation
      try {
        const response = await fetch(`${API_BASE}/api/templates`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentToken}`
          },
          body: JSON.stringify({
            name: 'Researcher Test Template',
            description: 'Testing researcher access',
            category: 'usability-testing',
            blocks: []
          })
        });
        results.push(`Create: ${response.status} ${response.ok ? 'SUCCESS' : 'FAILED'}`);
      } catch (error) {
        results.push(`Create: ERROR - ${error.message}`);
      }

      showResponse('researcherResponse', results.join('\n'), 'info');
      recordTestResult('Researcher Access Test', results.every(r => r.includes('SUCCESS')), results.join(', '));
    }

    async function testParticipantAccess() {
      if (currentUser?.role !== 'participant') {
        showResponse('participantResponse', 'Please login as participant first', 'error');
        return;
      }

      const results = [];
      
      // Test template creation (should fail)
      try {
        const response = await fetch(`${API_BASE}/api/templates`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentToken}`
          },
          body: JSON.stringify({
            name: 'Participant Test Template',
            description: 'Testing participant access (should fail)',
            category: 'usability-testing',
            blocks: []
          })
        });
        results.push(`Create: ${response.status} ${!response.ok ? 'CORRECTLY DENIED' : 'INCORRECTLY ALLOWED'}`);
      } catch (error) {
        results.push(`Create: ERROR - ${error.message}`);
      }

      showResponse('participantResponse', results.join('\n'), 'info');
      recordTestResult('Participant Access Test', results.every(r => r.includes('CORRECTLY DENIED')), results.join(', '));
    }

    async function testAdminAccess() {
      if (currentUser?.role !== 'admin') {
        showResponse('adminResponse', 'Please login as admin first', 'error');
        return;
      }

      const results = [];
      
      // Test template creation
      try {
        const response = await fetch(`${API_BASE}/api/templates`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentToken}`
          },
          body: JSON.stringify({
            name: 'Admin Test Template',
            description: 'Testing admin access',
            category: 'usability-testing',
            blocks: []
          })
        });
        results.push(`Create: ${response.status} ${response.ok ? 'SUCCESS' : 'FAILED'}`);
      } catch (error) {
        results.push(`Create: ERROR - ${error.message}`);
      }

      showResponse('adminResponse', results.join('\n'), 'info');
      recordTestResult('Admin Access Test', results.every(r => r.includes('SUCCESS')), results.join(', '));
    }

    // UI Integration tests
    async function testUIAuthStates() {
      const states = [
        { state: 'No Auth', user: null, token: null },
        { state: 'Researcher', user: currentUser?.role === 'researcher' ? currentUser : null, token: currentUser?.role === 'researcher' ? currentToken : null },
        { state: 'Participant', user: currentUser?.role === 'participant' ? currentUser : null, token: currentUser?.role === 'participant' ? currentToken : null },
        { state: 'Admin', user: currentUser?.role === 'admin' ? currentUser : null, token: currentUser?.role === 'admin' ? currentToken : null }
      ];

      const results = states.map(state => {
        const canCreate = state.user && ['researcher', 'admin'].includes(state.user.role);
        return `${state.state}: Can Create Templates = ${canCreate}`;
      });

      showResponse('uiAuthResponse', results.join('\n'), 'info');
      recordTestResult('UI Auth States Test', true, results.join(', '));
    }

    async function testFormSubmission() {
      if (!currentUser || !['researcher', 'admin'].includes(currentUser.role)) {
        showResponse('formResponse', 'Please login as researcher or admin first', 'error');
        recordTestResult('Form Submission Test', false, 'No valid user logged in');
        return;
      }

      const formData = {
        title: 'Test Form Submission',
        description: 'Testing template form submission with authentication',
        category: 'usability-testing',
        purpose: 'Testing purpose',
        difficulty: 'beginner',
        estimatedDuration: 30,
        recommendedParticipants: { min: 5, max: 15 },
        tags: ['test', 'form', 'auth'],
        blocks: [
          {
            id: 'block1',
            type: 'welcome_screen',
            title: 'Welcome',
            description: 'Welcome block',
            settings: { title: 'Welcome to our study' },
            isRequired: true,
            estimatedDuration: 2
          }
        ],
        metadata: {
          author: `${currentUser.firstName} ${currentUser.lastName}`,
          version: '1.0.0',
          isPublic: false
        }
      };

      try {
        const response = await fetch(`${API_BASE}/api/templates`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentToken}`
          },
          body: JSON.stringify(formData)
        });

        const result = await response.json();
        showResponse('formResponse', JSON.stringify(result, null, 2), response.ok ? 'success' : 'error');
        recordTestResult('Form Submission Test', response.ok, `Status: ${response.status}, ${result.message || 'Success'}`);
      } catch (error) {
        showResponse('formResponse', `Error: ${error.message}`, 'error');
        recordTestResult('Form Submission Test', false, error.message);
      }
    }

    // Utility functions
    function updateAuthStatus(user) {
      const statusText = document.getElementById('authStatusText');
      const roleElement = document.getElementById('userRole');
      
      if (user) {
        statusText.textContent = `Logged in as ${user.firstName} ${user.lastName} (${user.email})`;
        roleElement.textContent = user.role;
        roleElement.className = `role-indicator role-${user.role}`;
      } else {
        statusText.textContent = 'Not logged in';
        roleElement.textContent = 'No Auth';
        roleElement.className = 'role-indicator role-none';
      }
    }

    function showResponse(elementId, content, type) {
      const element = document.getElementById(elementId);
      element.textContent = content;
      element.style.display = 'block';
      element.className = `response-box ${type}`;
    }

    function recordTestResult(testName, success, details) {
      testResults.push({
        name: testName,
        success: success,
        details: details,
        timestamp: new Date().toISOString()
      });
      updateTestSummary();
    }

    function updateTestSummary() {
      const summary = document.getElementById('testSummary');
      const total = testResults.length;
      const passed = testResults.filter(r => r.success).length;
      const failed = total - passed;

      const summaryHTML = `
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
          <div style="text-align: center; padding: 15px; background: #e7f3ff; border-radius: 6px;">
            <div style="font-size: 24px; font-weight: bold; color: #007bff;">${total}</div>
            <div>Total Tests</div>
          </div>
          <div style="text-align: center; padding: 15px; background: #d4edda; border-radius: 6px;">
            <div style="font-size: 24px; font-weight: bold; color: #28a745;">${passed}</div>
            <div>Passed</div>
          </div>
          <div style="text-align: center; padding: 15px; background: #f8d7da; border-radius: 6px;">
            <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${failed}</div>
            <div>Failed</div>
          </div>
        </div>
        <div style="max-height: 300px; overflow-y: auto;">
          ${testResults.map(result => `
            <div style="padding: 8px; margin: 4px 0; border-radius: 4px; background: ${result.success ? '#d4edda' : '#f8d7da'};">
              <strong>${result.success ? '‚úÖ' : '‚ùå'} ${result.name}</strong><br>
              <small>${result.details}</small>
            </div>
          `).join('')}
        </div>
      `;
      
      summary.innerHTML = summaryHTML;
    }

    async function runAllTests() {
      // Clear previous results
      testResults = [];
      
      // Run comprehensive test suite
      await checkAuthStatus();
      await testGetTemplates(false);
      await testGetTemplates(true);
      await testGetCategories();
      await testCreateTemplate(false);
      await testCreateTemplate(true);
      await testUpdateTemplate(false);
      await testUpdateTemplate(true);
      await testDeleteTemplate(false);
      await testDeleteTemplate(true);
      await testDuplicateTemplate(false);
      await testDuplicateTemplate(true);
      
      if (currentUser) {
        if (currentUser.role === 'researcher') await testResearcherAccess();
        if (currentUser.role === 'participant') await testParticipantAccess();
        if (currentUser.role === 'admin') await testAdminAccess();
      }
      
      await testUIAuthStates();
      if (currentUser && ['researcher', 'admin'].includes(currentUser.role)) {
        await testFormSubmission();
      }
    }

    function clearResults() {
      testResults = [];
      document.getElementById('testSummary').innerHTML = '<p>Run tests to see summary...</p>';
      
      // Clear all response boxes
      const responseBoxes = document.querySelectorAll('.response-box');
      responseBoxes.forEach(box => {
        box.style.display = 'none';
        box.textContent = '';
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      checkAuthStatus();
    });
  </script>
</body>
</html>
